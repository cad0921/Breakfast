@model BreakFastShop.Models.OrderPageViewModel
@using System
@using System.Linq
@using System.Web.Helpers
@{
    Layout = null;
    var tablePayload = Model?.Table == null ? null : new
    {
        tableId = Model.Table.Id,
        number = Model.Table.Number,
        shopId = Model.Table.ShopId,
        shopName = Model.Table.ShopName,
        zone = Model.Table.Zone
    };
    var mealsPayload = Model?.Meals?
        .Select(m => (object)new { id = m.Id, name = m.Name, money = m.Money, element = m.Element, categoryId = m.CategoryId, categoryName = m.CategoryName, optionsJson = m.OptionsJson })
        .ToList() ?? new List<object>();
    var categoriesPayload = Model?.Categories?
        .Select(c => (object)new { id = c.Id, name = c.Name })
        .ToList() ?? new List<object>();
    var errorMessage = Model?.Error;
    var viewMode = (Request["view"] ?? string.Empty).Trim();
    var isReceiveEmbedded = viewMode.Equals("receive", StringComparison.OrdinalIgnoreCase);
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>下單頁</title>
    <script src="~/Scripts/jquery-3.7.0.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>

    <style>
        .modal, .modal-backdrop { position: fixed; }
        .modal { z-index: 1055; }
        .modal-backdrop { z-index: 1050; }

        :root {
            --page-bg: #f1f5f9;
            --panel-bg: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --muted: #64748b;
            --brand: #be123c;
            --brand-dark: #9f1239;
            --success: #059669;
            --danger: #dc2626;
            --shadow: 0 18px 40px rgba(15, 23, 42, 0.1);
            --sticky-header-offset: 6.5rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--page-bg);
            color: var(--text);
            font-family: "Noto Sans TC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            min-height: 100vh;
        }

        h1, h2, h3 {
            font-weight: 700;
        }

        .order-page {
            flex: 1;
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .order-shell {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 720px;
            background: var(--page-bg);
            min-height: 100vh;
        }

        .order-header {
            position: sticky;
            top: 0;
            z-index: 20;
            padding: 1rem 1.25rem 1.5rem;
            background: linear-gradient(140deg, #be123c, #f43f5e);
            color: #fff;
            box-shadow: 0 20px 40px rgba(190, 18, 60, 0.25);
        }

        .order-header__title {
            display: flex;
            flex-direction: column;
            gap: .25rem;
            margin-bottom: 1rem;
        }

        .order-header__controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: .75rem;
        }

        .order-mode-switch {
            display: inline-flex;
            padding: .3rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.18);
            gap: .35rem;
        }

        .order-mode-btn {
            border: none;
            border-radius: 999px;
            padding: .35rem 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.85);
            background: transparent;
            cursor: pointer;
            transition: background .2s ease, color .2s ease;
        }

        .order-mode-btn.is-active {
            background: rgba(255, 255, 255, 0.32);
            color: #fff;
        }

        .order-mode-btn:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.65);
            outline-offset: 2px;
        }

        #pageTitle {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: .02em;
        }

        .order-header__subtitle {
            font-size: .85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .table-summary {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 18px;
            padding: .85rem 1rem;
            display: flex;
            flex-direction: column;
            gap: .35rem;
            transition: background .2s ease, border-color .2s ease, color .2s ease;
        }

        .table-summary-status {
            font-weight: 600;
            font-size: 1rem;
        }

        .table-summary-detail {
            font-size: .9rem;
            color: rgba(255, 255, 255, 0.85);
        }

        .table-summary.is-success {
            background: rgba(5, 150, 105, 0.2);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .table-summary.is-success .table-summary-status {
            color: #d1fae5;
        }

        .table-summary.is-error {
            background: rgba(220, 38, 38, 0.22);
            border-color: rgba(248, 113, 113, 0.55);
        }

        .table-summary.is-error .table-summary-status {
            color: #fee2e2;
        }

        .panel .table-summary {
            background: #f8fafc;
            border-color: rgba(148, 163, 184, 0.35);
            color: var(--text);
        }

        .panel .table-summary-status {
            color: var(--text);
        }

        .panel .table-summary-detail {
            color: var(--muted);
        }

        .order-main {
            flex: 1;
            padding: 1.5rem 1.25rem 6.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
        }

        .order-context {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .order-context-body {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .order-mode-panels {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .order-mode-panel {
            display: none;
            flex-direction: column;
            gap: 1rem;
        }

        .order-mode-panel.is-active {
            display: flex;
        }

        .order-form {
            display: flex;
            flex-direction: column;
            gap: .6rem;
        }

        .order-form-controls {
            display: flex;
            flex-wrap: wrap;
            gap: .6rem;
        }

        .order-form-input {
            flex: 1;
            min-width: 0;
            padding: .65rem .9rem;
            border-radius: 14px;
            border: 1px solid var(--border);
            font-size: 1rem;
            color: var(--text);
            background: #fff;
        }

        .order-form-input:focus {
            outline: none;
            border-color: #94a3b8;
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.2);
        }

        .order-form-submit {
            border: none;
            border-radius: 14px;
            padding: .65rem 1.3rem;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: transform .15s ease, box-shadow .15s ease;
        }

        .order-form-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
        }

        .order-form-label {
            font-size: .9rem;
            font-weight: 600;
            color: var(--muted);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .75rem;
            margin-bottom: 1rem;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .section-note {
            font-size: .9rem;
            color: var(--muted);
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 1.25rem;
        }

        .meal-panel {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .meal-categories {
            position: sticky;
            top: var(--sticky-header-offset);
            z-index: 15;
            margin: 0 -1.25rem;
            padding: .75rem 1.25rem .35rem;
            background: #fff;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        .meal-categories-list {
            display: flex;
            gap: .6rem;
            overflow-x: auto;
            padding-bottom: .5rem;
        }

        .meal-category-btn {
            border: 1px solid var(--border);
            background: #f8fafc;
            color: var(--text);
            border-radius: 999px;
            padding: .45rem 1.1rem;
            font-size: .95rem;
            font-weight: 600;
            white-space: nowrap;
            transition: all .2s ease;
        }

        .meal-category-btn:focus,
        .meal-category-btn:hover {
            border-color: rgba(244, 63, 94, 0.45);
            color: #f43f5e;
        }

        .meal-category-btn.active {
            background: linear-gradient(135deg, #be123c, #f43f5e);
            border-color: transparent;
            color: #fff;
            box-shadow: 0 16px 32px rgba(244, 63, 94, 0.3);
        }

        .meal-categories-empty,
        .meal-empty {
            background: #f8fafc;
            border: 1px dashed var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            color: var(--muted);
            text-align: center;
            font-size: .95rem;
        }

        .meal-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .meal-card {
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 1.1rem 1.25rem;
            background: #fff;
            box-shadow: 0 16px 36px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: .5rem;
        }

        .meal-card.selected {
            border-color: rgba(244, 63, 94, 0.65);
            box-shadow: 0 18px 40px rgba(244, 63, 94, 0.28);
        }

        .meal-name {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .meal-price {
            color: #f43f5e;
            font-weight: 700;
        }

        .meal-element {
            color: var(--muted);
            font-size: .9rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .meal-category-label {
            align-self: flex-start;
            padding: .2rem .65rem;
            border-radius: 999px;
            background: #fef2f2;
            color: #be123c;
            font-size: .8rem;
            font-weight: 600;
        }

        .meal-card button {
            align-self: flex-start;
            padding: .55rem 1.35rem;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #fb7185, #f43f5e);
            color: #fff;
            font-weight: 700;
            letter-spacing: .02em;
            cursor: pointer;
            box-shadow: 0 18px 38px rgba(244, 63, 94, 0.35);
            transition: transform .2s ease, box-shadow .2s ease;
        }

        .meal-card button:hover {
            transform: translateY(-1px);
            box-shadow: 0 22px 44px rgba(244, 63, 94, 0.38);
        }

        .meal-card button:active {
            transform: translateY(0);
        }

        .meal-card button:disabled {
            background: #cbd5f5;
            color: #475569;
            box-shadow: none;
            cursor: not-allowed;
        }

        .meal-cart-indicator {
            font-size: .9rem;
            color: var(--muted);
        }

        .cart-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-review {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-review-actions {
            display: flex;
            flex-direction: column;
            gap: .75rem;
        }

        .order-review-submit {
            margin-top: .5rem;
        }

        .cart-summary {
            color: var(--muted);
            font-size: .95rem;
        }

        .cart-list {
            display: flex;
            flex-direction: column;
            gap: .85rem;
        }

        .cart-empty {
            background: #f8fafc;
            border: 1px dashed var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            text-align: center;
            color: var(--muted);
        }

        .cart-item {
            display: flex;
            flex-direction: column;
            gap: .75rem;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem 1.1rem;
            background: #fff;
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
        }

        .cart-item-header {
            display: flex;
            flex-direction: column;
            gap: .3rem;
        }

        .cart-item-name {
            font-size: 1rem;
            font-weight: 700;
        }

        .cart-item-price {
            color: var(--muted);
            font-size: .9rem;
        }

        .cart-item-note {
            font-size: .85rem;
            color: #94a3b8;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: .75rem;
        }

        .cart-item-qty {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            background: #f8fafc;
            border-radius: 999px;
            padding: .35rem .6rem;
        }

        .cart-qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #fee2e2;
            color: #be123c;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-qty-btn:active {
            transform: scale(.96);
        }

        .cart-item-qty-value {
            font-weight: 700;
            min-width: 2rem;
            text-align: center;
        }

        .cart-item-subtotal {
            font-weight: 700;
            color: var(--text);
        }

        .cart-remove {
            border: none;
            background: transparent;
            color: var(--danger);
            font-weight: 600;
            cursor: pointer;
        }

        .cart-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: .75rem;
        }

        .cart-total {
            font-size: 1.15rem;
            font-weight: 800;
        }

        .cart-clear {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--muted);
            border-radius: 999px;
            padding: .45rem 1.15rem;
            font-weight: 600;
            cursor: pointer;
        }

        .cart-clear:disabled {
            opacity: .45;
            cursor: not-allowed;
        }

        .cart-clear:not(:disabled):hover {
            color: #be123c;
            border-color: rgba(190, 18, 60, 0.45);
        }

        .order-layout {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .order-layout-main {
            flex: 1;
        }

        .cart-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-footer {
            position: sticky;
            bottom: 0;
            padding: 1rem 1.25rem 1.5rem;
            background: rgba(248, 250, 252, 0.96);
            backdrop-filter: blur(12px);
            box-shadow: 0 -18px 32px rgba(15, 23, 42, 0.1);
            display: flex;
            justify-content: center;
        }

        .order-submit-button {
            width: 100%;
            max-width: 680px;
            border: none;
            border-radius: 999px;
            padding: .95rem 1.25rem;
            background: linear-gradient(135deg, #be123c, #f43f5e);
            color: #fff;
            font-size: 1.05rem;
            font-weight: 700;
            letter-spacing: .02em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .75rem;
            box-shadow: 0 24px 44px rgba(244, 63, 94, 0.38);
        }

        .order-submit-button:disabled {
            background: #cbd5f5;
            color: #475569;
            box-shadow: none;
            cursor: not-allowed;
        }

        .order-submit-button__count {
            min-width: 2rem;
            height: 2rem;
            border-radius: 999px;
            background: #fff;
            color: #be123c;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .95rem;
        }

        .is-hidden {
            display: none !important;
        }

        .meal-options-modal {
            position: fixed;
            inset: 0;
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s ease;
            z-index: 35;
        }

        .meal-options-modal.is-active {
            opacity: 1;
            pointer-events: auto;
        }

        .meal-options-modal__content {
            background: #fff;
            border-radius: 22px;
            width: min(520px, 100%);
            max-height: min(90vh, 640px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 26px 52px rgba(15, 23, 42, 0.28);
            overflow: hidden;
        }

        .meal-options-modal__header {
            padding: 1.1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .meal-options-modal__title {
            margin: 0;
            font-size: 1.2rem;
        }

        .meal-options-modal__close {
            border: none;
            background: transparent;
            font-size: 1.8rem;
            line-height: 1;
            cursor: pointer;
            color: var(--muted);
        }

        .meal-options-modal__close:hover,
        .meal-options-modal__close:focus {
            color: var(--brand);
        }

        .meal-options-modal__body {
            padding: 1.25rem 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .meal-options-modal__meal {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .meal-options-error {
            padding: .75rem 1rem;
            border-radius: .8rem;
            background: rgba(220, 38, 38, 0.12);
            color: var(--danger);
            font-size: .9rem;
        }

        .meal-options-groups {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .meal-option-group {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem;
            background: #f8fafc;
        }

        .meal-option-group__header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: .75rem;
            margin-bottom: .75rem;
        }

        .meal-option-group__name {
            font-weight: 600;
            font-size: 1rem;
        }

        .meal-option-group__meta {
            font-size: .85rem;
            color: var(--muted);
        }

        .meal-option-group__items {
            display: flex;
            flex-direction: column;
            gap: .6rem;
        }

        .meal-option-group__empty {
            padding: .8rem;
            border: 1px dashed var(--border);
            border-radius: 12px;
            color: var(--muted);
            text-align: center;
            font-size: .9rem;
        }

        .meal-option-item {
            display: flex;
            gap: .75rem;
            align-items: flex-start;
            padding: .55rem .65rem;
            border-radius: 12px;
            border: 1px solid transparent;
            background: #fff;
            cursor: pointer;
        }

        .meal-option-item:hover,
        .meal-option-item:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.25);
        }

        .meal-option-item input {
            margin-top: .35rem;
        }

        .meal-option-item__label {
            display: flex;
            flex-direction: column;
            gap: .25rem;
        }

        .meal-option-item__name {
            font-weight: 600;
        }

        .meal-option-item__price {
            font-size: .85rem;
            color: var(--muted);
        }

        .meal-options-summary {
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: .5rem;
        }

        .meal-options-summary__row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: .95rem;
        }

        .meal-options-summary__total {
            font-size: 1.05rem;
            font-weight: 700;
        }

        .meal-options-modal__footer {
            padding: 1.1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: .75rem;
        }

        .meal-options-btn {
            border-radius: 999px;
            padding: .65rem 1.4rem;
            font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .meal-options-btn--ghost {
            background: transparent;
            border-color: var(--border);
            color: var(--text);
        }

        .meal-options-btn--ghost:hover,
        .meal-options-btn--ghost:focus {
            border-color: var(--accent);
            color: var(--accent);
        }

        .meal-options-btn--primary {
            background: linear-gradient(120deg, #f43f5e, #fb7185);
            color: #fff;
            border: none;
            box-shadow: 0 14px 30px rgba(244, 63, 94, 0.28);
        }

        .meal-options-btn--primary:disabled {
            opacity: .5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .meal-options-btn--primary:not(:disabled):hover,
        .meal-options-btn--primary:not(:disabled):focus {
            transform: translateY(-1px);
        }

        .order-confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 40;
        }

        .order-confirm-modal.is-active {
            display: flex;
        }

        .order-confirm-modal__content {
            background: #fff;
            border-radius: 22px;
            width: min(520px, 100%);
            max-height: min(90vh, 640px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 28px 60px rgba(15, 23, 42, 0.32);
            outline: none;
        }

        .order-confirm-modal__header {
            padding: 1.25rem 1.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .order-confirm-modal__title {
            margin: 0;
            font-size: 1.35rem;
        }

        .order-confirm-modal__close {
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 1.75rem;
            line-height: 1;
            cursor: pointer;
        }

        .order-confirm-modal__body {
            padding: 1rem 1.5rem;
            overflow-y: auto;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .order-confirm-info {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: .85rem 1.1rem;
            color: var(--text);
            line-height: 1.6;
        }

        .order-confirm-items table {
            width: 100%;
            border-collapse: collapse;
            font-size: .95rem;
        }

        .order-confirm-items th,
        .order-confirm-items td {
            padding: .55rem .35rem;
            text-align: left;
        }

        .order-confirm-items th {
            font-weight: 700;
            border-bottom: 1px solid var(--border);
        }

        .order-confirm-items td {
            border-bottom: 1px solid #eef2f8;
        }

        .order-confirm-name {
            font-weight: 600;
        }

        .order-confirm-note {
            margin-top: .3rem;
            font-size: .85rem;
            color: var(--muted);
            line-height: 1.4;
        }

        .order-confirm-items th:last-child,
        .order-confirm-items td:last-child {
            text-align: right;
        }

        .order-confirm-empty td {
            text-align: center;
            color: var(--muted);
            padding: 1.25rem .35rem;
        }

        .order-confirm-items th:nth-child(2),
        .order-confirm-items td:nth-child(2) {
            width: 7rem;
            text-align: center;
        }

        .order-confirm-qty {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .45rem;
        }

        .order-confirm-qty-btn {
            width: 2.2rem;
            height: 2.2rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            font-size: 1.1rem;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background .2s ease, color .2s ease, border-color .2s ease;
        }

        .order-confirm-qty-btn:focus,
        .order-confirm-qty-btn:hover {
            background: #f8fafc;
            border-color: #cbd5f5;
        }

        .order-confirm-qty-value {
            min-width: 1.5rem;
            text-align: center;
            font-weight: 700;
        }

        .order-confirm-subtotal-value {
            font-weight: 700;
        }

        .order-confirm-remove {
            background: transparent;
            border: none;
            color: #ef4444;
            font-weight: 600;
            cursor: pointer;
            margin-left: .75rem;
        }

        .order-confirm-total {
            display: flex;
            justify-content: flex-end;
            font-weight: 800;
            margin-top: .5rem;
            font-size: 1.05rem;
        }

        .order-confirm-modal__footer {
            padding: 1.1rem 1.5rem 1.5rem;
            border-top: 1px solid #f1f5f9;
            display: flex;
            justify-content: flex-end;
        }

        #confirmSubmit {
            padding: .75rem 1.65rem;
            border: none;
            border-radius: 999px;
            background: linear-gradient(135deg, #be123c, #f43f5e);
            color: #fff;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 16px 32px rgba(244, 63, 94, 0.32);
        }

        #confirmSubmit:disabled {
            opacity: .7;
            cursor: not-allowed;
            box-shadow: none;
        }

        @@media (min-width: 768px) {
            #pageTitle {
                font-size: 1.75rem;
            }

            .order-main {
                padding: 2rem 2rem 6.75rem;
            }

            .order-footer {
                padding: 1.5rem 2rem 2rem;
            }
        }

        @@media (min-width: 992px) {
            .order-layout {
                flex-direction: row;
                align-items: flex-start;
            }

            .cart-panel {
                width: min(320px, 100%);
                position: sticky;
                top: 120px;
            }

            .order-layout.order-layout--review {
                align-items: stretch;
            }

            .order-layout--review .order-review {
                width: min(340px, 100%);
                position: sticky;
                top: 120px;
            }
        }

        @@media (min-width: 1024px) {
            .order-shell {
                max-width: 840px;
            }
        }
    </style>

</head>

<body>
    <div class="order-page">
        <div class="order-shell">
            <header class="order-header">
                <div class="order-header__title">
                    <h1 id="pageTitle">下單頁</h1>
                    <span class="order-header__subtitle">選擇餐點並送出訂單</span>
                </div>
                <div class="order-header__controls"></div>
            </header>
            <main class="order-main" role="main">
                <section class="order-layout@(isReceiveEmbedded ? " order-layout--review" : string.Empty)">
                    <div class="meal-categories" id="mealCategories" aria-live="polite"></div>
                    <div class="order-layout-main">
                        <section class="meal-panel panel" aria-labelledby="mealSectionTitle">
                            <div class="section-header">
                                <h2 id="mealSectionTitle">餐點列表</h2>
                                <span class="section-note">挑選想吃的料理</span>
                            </div>
                            <div class="meal-list" id="mealList" aria-live="polite"></div>
                        </section>
                    </div>
@if(isReceiveEmbedded)
{
                    <section class="order-review panel" aria-labelledby="orderReviewTitle">
                        <div class="section-header">
                            <h2 id="orderReviewTitle">訂單確認</h2>
                            <span class="section-note">檢視與調整已選餐點</span>
                        </div>
                        <div class="order-confirm-info" id="orderReviewInfo"></div>
                        <div class="order-confirm-items">
                            <table>
                                <thead>
                                    <tr>
                                        <th scope="col">餐點</th>
                                        <th scope="col">數量</th>
                                        <th scope="col">小計</th>
                                    </tr>
                                </thead>
                                <tbody id="orderReviewItems"></tbody>
                            </table>
                        </div>
                        <div class="order-confirm-total" id="orderReviewTotal"></div>
                        <div class="order-review-actions">
                            <button type="button" class="order-submit-button order-review-submit" id="orderReviewSubmit" disabled>送出訂單</button>
                        </div>
                    </section>
}
                </section>
            </main>
@if(!isReceiveEmbedded)
{
            <footer class="order-footer">
                <button id="send" class="order-submit-button" disabled>
                    <span class="order-submit-button__label">確認訂單</span>
                    <span class="order-submit-button__count is-hidden" id="sendCount">0</span>
                </button>
            </footer>
}
        </div>
    </div>
    <div class="meal-options-modal" id="mealOptionsModal" role="dialog" aria-modal="true" aria-labelledby="mealOptionsTitle" aria-hidden="true">
        <div class="meal-options-modal__content" tabindex="-1">
            <div class="meal-options-modal__header">
                <h3 class="meal-options-modal__title" id="mealOptionsTitle">客製化選項</h3>
                <button type="button" class="meal-options-modal__close" id="mealOptionsClose" aria-label="關閉選項視窗">×</button>
            </div>
            <div class="meal-options-modal__body">
                <div class="meal-options-modal__meal" id="mealOptionsName"></div>
                <div class="meal-options-error is-hidden" id="mealOptionsError"></div>
                <div class="meal-options-groups" id="mealOptionsGroups"></div>
                <div class="meal-options-summary">
                    <div class="meal-options-summary__row">
                        <span>餐點價格</span>
                        <strong id="mealOptionsSummaryBase"></strong>
                    </div>
                    <div class="meal-options-summary__row">
                        <span>加價項目</span>
                        <strong id="mealOptionsSummaryExtra"></strong>
                    </div>
                    <div class="meal-options-summary__row meal-options-summary__total">
                        <span>小計</span>
                        <strong id="mealOptionsSummaryTotal"></strong>
                    </div>
                </div>
            </div>
            <div class="meal-options-modal__footer">
                <button type="button" class="meal-options-btn meal-options-btn--ghost" id="mealOptionsCancel">取消</button>
                <button type="button" class="meal-options-btn meal-options-btn--primary" id="mealOptionsConfirm">加入購物車</button>
            </div>
        </div>
    </div>
    <div class="order-confirm-modal" id="orderConfirmModal" role="dialog" aria-modal="true" aria-labelledby="orderConfirmTitle" aria-hidden="true">
        <div class="order-confirm-modal__content" tabindex="-1">
            <div class="order-confirm-modal__header">
                <h3 class="order-confirm-modal__title" id="orderConfirmTitle">餐點確認</h3>
                <button type="button" class="order-confirm-modal__close" id="orderConfirmClose" aria-label="關閉訂單確認視窗">×</button>
            </div>
            <div class="order-confirm-modal__body">
                <div class="order-confirm-info" id="orderConfirmTable"></div>
                <div class="order-confirm-items">
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">餐點</th>
                                <th scope="col">數量</th>
                                <th scope="col">小計</th>
                            </tr>
                        </thead>
                        <tbody id="orderConfirmItems"></tbody>
                    </table>
                    <div class="order-confirm-total" id="orderConfirmTotal"></div>
                </div>
            </div>
            <div class="order-confirm-modal__footer">
                <button type="button" id="confirmSubmit">確定送出</button>
            </div>
        </div>
    </div>
    <script>
  (function(){
    var hub = $.connection.ordersHub;
    var lookupUrl = '@Url.Action("TableInfo","Home")';
    var mealLookupUrl = '@Url.Action("ShopMeals","Home")';
    var shopInfoUrl = '@Url.Action("ShopInfo","Home")';
    var ORDER_MODE_DINE_IN = 'dineIn';
    var ORDER_MODE_TAKEOUT = 'takeout';
    var currentMode = ORDER_MODE_DINE_IN;
    var currentTable = null;
    var initialTable = @Html.Raw(Json.Encode(tablePayload));
    var initialMeals = @Html.Raw(Json.Encode(mealsPayload));
    var initialCategories = @Html.Raw(Json.Encode(categoriesPayload));
    var initialError = @Html.Raw(Json.Encode(errorMessage));
    var allMeals = [];
    var allCategories = [];
    var activeCategoryId = null;
    var cartItems = [];
    var currentTakeoutShop = null;
    var currentMealsShopId = null;
    var pendingSubmitMode = null;

    var $orderModeButtons = $('[data-order-mode]');
    var $orderModePanels = $('[data-order-mode-panel]');
    var $tableForm = $('#tableLookupForm');
    var $tableInput = $('#tableNumberInput');
    var $takeoutForm = $('#takeoutShopForm');
    var $takeoutInput = $('#takeoutShopInput');
    var $cartList = $('#cartList');
    var $cartTotal = $('#cartTotal');
    var $cartEmpty = $('#cartEmpty');
    var $cartSummary = $('#cartSummary');
    var $clearCart = $('#clearCart');
    var $sendButton = $('#send');
    var $sendCount = $('#sendCount');
    var $tableSummary = $('#tableSummary');
    var $tableStatus = $('#tableStatus');
    var $tableDetail = $('#tableDetail');
    var $takeoutSummary = $('#takeoutSummary');
    var $takeoutStatus = $('#takeoutStatus');
    var $takeoutDetail = $('#takeoutDetail');
    var $takeoutCodeInput = $('#takeoutCodeInput');
    var $pageTitle = $('#pageTitle');
    var isReceiveEmbedded = @(isReceiveEmbedded.ToString().ToLowerInvariant());
    var $orderConfirmModal = $('#orderConfirmModal');
    var $orderConfirmClose = $('#orderConfirmClose');
    var $orderConfirmContent = $orderConfirmModal.find('.order-confirm-modal__content');
    var $orderConfirmTable = $('#orderConfirmTable');
    var $orderConfirmItems = $('#orderConfirmItems');
    var $orderConfirmTotal = $('#orderConfirmTotal');
    var $confirmSubmit = $('#confirmSubmit');
    var $orderReviewInfo = $('#orderReviewInfo');
    var $orderReviewItems = $('#orderReviewItems');
    var $orderReviewTotal = $('#orderReviewTotal');
    var $orderReviewSubmit = $('#orderReviewSubmit');
    var $mealOptionsModal = $('#mealOptionsModal');
    var $mealOptionsContent = $mealOptionsModal.find('.meal-options-modal__content');
    var $mealOptionsName = $('#mealOptionsName');
    var $mealOptionsGroups = $('#mealOptionsGroups');
    var $mealOptionsError = $('#mealOptionsError');
    var $mealOptionsSummaryBase = $('#mealOptionsSummaryBase');
    var $mealOptionsSummaryExtra = $('#mealOptionsSummaryExtra');
    var $mealOptionsSummaryTotal = $('#mealOptionsSummaryTotal');
    var $mealOptionsCancel = $('#mealOptionsCancel');
    var $mealOptionsConfirm = $('#mealOptionsConfirm');
    var $mealOptionsClose = $('#mealOptionsClose');
    var defaultMealOptionsExtraText = '不加價';
    var pendingMealForOptions = null;
    var pendingMealOptionGroups = [];
    var defaultTableStatus = '請輸入桌號以開始點餐。';
    var defaultTakeoutStatus = '請輸入店家代碼以顯示餐點。';
    var defaultPageTitle = '下單頁';
    var isSubmitting = false;
    var confirmSubmitDefaultText = $confirmSubmit.text();
    var orderReviewSubmitDefaultText = $orderReviewSubmit.length ? $orderReviewSubmit.text() : '';

    function setTableStatus(message, type){
      var text = message || defaultTableStatus;
      var statusClass = type === 'success' ? 'is-success' : (type === 'error' ? 'is-error' : null);
      $tableSummary.removeClass('is-success is-error');
      if(statusClass){
        $tableSummary.addClass(statusClass);
      }
      if(text){
        $tableStatus.text(text).removeClass('is-hidden');
      } else {
        $tableStatus.text('').addClass('is-hidden');
      }
    }

    function setTableDetail(text){
      if(text){
        $tableDetail.text(text).removeClass('is-hidden');
      } else {
        $tableDetail.text('').addClass('is-hidden');
      }
    }

    function updatePageTitle(table){
      if(table && table.number !== undefined && table.number !== null){
        var name = table.shopName || table.shopId || defaultPageTitle;
        var zoneText = table.zone ? ('（' + table.zone + '）') : '';
        var titleText = name + ' 桌號 ' + table.number + zoneText;
        $pageTitle.text(titleText);
        document.title = titleText;
      } else {
        $pageTitle.text(defaultPageTitle);
        document.title = defaultPageTitle;
      }
    }

    function setTakeoutStatus(message, type){
      var text = message || defaultTakeoutStatus;
      var statusClass = type === 'success' ? 'is-success' : (type === 'error' ? 'is-error' : null);
      $takeoutSummary.removeClass('is-success is-error');
      if(statusClass){
        $takeoutSummary.addClass(statusClass);
      }
      if(text){
        $takeoutStatus.text(text).removeClass('is-hidden');
      } else {
        $takeoutStatus.text('').addClass('is-hidden');
      }
    }

    function setTakeoutDetail(text){
      if(text){
        $takeoutDetail.text(text).removeClass('is-hidden');
      } else {
        $takeoutDetail.text('').addClass('is-hidden');
      }
    }

    function updateTakeoutTitle(shop){
      if(shop && (shop.name || shop.rawId)){
        var titleText = (shop.name || shop.rawId) + ' 外帶訂單';
        $pageTitle.text(titleText);
        document.title = titleText;
      } else {
        $pageTitle.text(defaultPageTitle);
        document.title = defaultPageTitle;
      }
    }

    function setOrderMode(mode){
      var target = mode === ORDER_MODE_TAKEOUT ? ORDER_MODE_TAKEOUT : ORDER_MODE_DINE_IN;
      currentMode = target;

      if($orderModeButtons.length){
        $orderModeButtons.removeClass('is-active').attr('aria-pressed', 'false');
        $orderModeButtons.filter('[data-order-mode="' + target + '"]').addClass('is-active').attr('aria-pressed', 'true');
      }

      if($orderModePanels.length){
        $orderModePanels.removeClass('is-active').attr('aria-hidden', 'true');
        $orderModePanels.filter('[data-order-mode-panel="' + target + '"]').addClass('is-active').attr('aria-hidden', 'false');
      }

      if(target === ORDER_MODE_DINE_IN){
        updatePageTitle(currentTable);
        if(currentTable && currentTable.shopId){
          setTableStatus('已連線至桌號 ' + currentTable.number + (currentTable.zone ? ('（' + currentTable.zone + '）') : '') + '。', 'success');
          setTableDetail('餐廳：' + (currentTable.shopName || currentTable.shopId));
          if(String(currentMealsShopId || '') !== String(currentTable.shopId || '')){
            fetchMealsForShop(currentTable.shopId, { onError: setTableStatus, onSuccess: function(){ setTableStatus('已載入餐點，請選擇。', 'success'); } });
          }
        } else {
          setTableStatus(defaultTableStatus, '');
          setTableDetail('');
          setCategories([]);
          setMeals([]);
          clearCart({ skipStatus: true });
        }

        setTakeoutStatus(defaultTakeoutStatus, '');
        setTakeoutDetail('');
      } else {
        if(currentTakeoutShop && currentTakeoutShop.id){
          updateTakeoutTitle(currentTakeoutShop);
          var name = currentTakeoutShop.name || currentTakeoutShop.rawId;
          setTakeoutStatus('已連線至店家。', 'success');
          setTakeoutDetail('餐廳：' + name);
          if(String(currentMealsShopId || '') !== String(currentTakeoutShop.id || '')){
            fetchMealsForShop(currentTakeoutShop.id, {
              onError: function(msg){ setTakeoutStatus(msg, 'error'); },
              onSuccess: function(){ setTakeoutStatus('已載入餐點，請選擇。', 'success'); }
            });
          }
        } else {
          updateTakeoutTitle(null);
          setTakeoutStatus(defaultTakeoutStatus, '');
          setTakeoutDetail('');
          setCategories([]);
          setMeals([]);
          clearCart({ skipStatus: true });
        }

        setTableStatus(defaultTableStatus, '');
        setTableDetail('');
      }

      updateSendButtonState();
    }

    function notifyCartStatus(message, type){
      if(currentMode === ORDER_MODE_TAKEOUT){
        setTakeoutStatus(message, type);
      } else {
        setTableStatus(message, type);
      }
    }

    function setStatusForMode(mode, message, type){
      if(mode === ORDER_MODE_TAKEOUT){
        setTakeoutStatus(message, type);
      } else {
        setTableStatus(message, type);
      }
    }

    function formatCurrency(value){
      return 'NT$ ' + (Number(value) || 0).toLocaleString('zh-TW');
    }

    function normalizeOptionItem(data){
      if(!data){ return null; }
      var name = '';
      if(data.name != null){ name = String(data.name).trim(); }
      else if(data.Name != null){ name = String(data.Name).trim(); }
      else if(data.title != null){ name = String(data.title).trim(); }
      else if(data.Title != null){ name = String(data.Title).trim(); }
      if(!name){ return null; }

      var priceSource = data.price != null ? data.price :
        (data.Price != null ? data.Price :
        (data.money != null ? data.money : data.Money));

      var price = 0;
      if(priceSource != null){
        var parsed = parseFloat(priceSource);
        price = isFinite(parsed) ? parsed : 0;
      }

      return { name: name, price: price };
    }

    function normalizeOptionGroup(data){
      if(!data){ return null; }
      var name = '';
      if(data.name != null){ name = String(data.name).trim(); }
      else if(data.Name != null){ name = String(data.Name).trim(); }
      else if(data.title != null){ name = String(data.title).trim(); }
      else if(data.Title != null){ name = String(data.Title).trim(); }
      if(!name){ return null; }

      var required = !!(data.required || data.Required || data.isRequired || data.IsRequired);
      var allowMultiple = !!(data.allowMultiple || data.AllowMultiple || data.multi || data.Multi || data.multiple || data.Multiple || data.allowMulti || data.AllowMulti);

      var rawMax = null;
      if(data.maxSelect != null){ rawMax = data.maxSelect; }
      else if(data.MaxSelect != null){ rawMax = data.MaxSelect; }
      else if(data.maxSelection != null){ rawMax = data.maxSelection; }
      else if(data.MaxSelection != null){ rawMax = data.MaxSelection; }
      else if(data.max != null){ rawMax = data.max; }
      else if(data.Max != null){ rawMax = data.Max; }
      else if(data.limit != null){ rawMax = data.limit; }
      else if(data.Limit != null){ rawMax = data.Limit; }
      else if(data.maximum != null){ rawMax = data.maximum; }
      else if(data.Maximum != null){ rawMax = data.Maximum; }

      var itemsSource = [];
      if(Array.isArray(data.items)){ itemsSource = data.items; }
      else if(Array.isArray(data.Items)){ itemsSource = data.Items; }
      else if(Array.isArray(data.options)){ itemsSource = data.options; }
      else if(Array.isArray(data.Options)){ itemsSource = data.Options; }
      else if(Array.isArray(data.choices)){ itemsSource = data.choices; }
      else if(Array.isArray(data.Choices)){ itemsSource = data.Choices; }

      var items = [];
      itemsSource.forEach(function(itemData){
        var normalized = normalizeOptionItem(itemData);
        if(normalized){ items.push(normalized); }
      });

      if(!items.length){ return null; }

      var maxSelect = 1;
      if(allowMultiple){
        var parsedMax = parseInt(rawMax, 10);
        if(isFinite(parsedMax) && parsedMax > 0){
          maxSelect = Math.min(parsedMax, items.length);
        } else {
          maxSelect = items.length;
        }
        if(maxSelect <= 0){
          maxSelect = items.length;
        }
      }

      return {
        name: name,
        required: required,
        allowMultiple: allowMultiple,
        maxSelect: allowMultiple ? maxSelect : 1,
        items: items
      };
    }

    function getMealOptionGroups(meal){
      if(!meal){ return []; }
      if(Array.isArray(meal._normalizedOptions)){ return meal._normalizedOptions; }
      var raw = meal.optionsJson || meal.OptionsJson || meal.OptionsJSON || '';
      if(typeof raw === 'string'){
        raw = raw.trim();
      }
      if(!raw){
        meal._normalizedOptions = [];
        return meal._normalizedOptions;
      }
      var parsed = null;
      if(typeof raw === 'string'){
        try { parsed = JSON.parse(raw); }
        catch(e){
          meal._normalizedOptions = [];
          return meal._normalizedOptions;
        }
      } else if(typeof raw === 'object'){
        parsed = raw;
      }
      if(!parsed){
        meal._normalizedOptions = [];
        return meal._normalizedOptions;
      }
      var groupsSource = [];
      if(Array.isArray(parsed.groups)){ groupsSource = parsed.groups; }
      else if(Array.isArray(parsed.Groups)){ groupsSource = parsed.Groups; }
      var normalized = [];
      groupsSource.forEach(function(groupData){
        var normalizedGroup = normalizeOptionGroup(groupData);
        if(normalizedGroup){ normalized.push(normalizedGroup); }
      });
      meal._normalizedOptions = normalized;
      return normalized;
    }

    function cloneOptionSelections(selections){
      if(!Array.isArray(selections) || !selections.length){ return []; }
      return selections.map(function(group){
        return {
          name: group.name,
          items: (group.items || []).map(function(option){
            return { name: option.name, price: Number(option.price) || 0 };
          })
        };
      });
    }

    function calculateOptionsExtra(selections){
      var extra = 0;
      (selections || []).forEach(function(group){
        (group.items || []).forEach(function(option){
          extra += Number(option.price) || 0;
        });
      });
      return extra;
    }

    function buildOptionsKey(selections){
      if(!Array.isArray(selections) || !selections.length){ return ''; }
      var parts = [];
      selections.forEach(function(group){
        if(!group || !group.items || !group.items.length){ return; }
        var itemParts = group.items.map(function(option){
          return option.name + String.fromCharCode(64) + (Number(option.price) || 0);
        }).join('|');
        parts.push(group.name + ':' + itemParts);
      });
      return parts.join(';');
    }

    function buildOptionsNote(selections){
      if(!Array.isArray(selections) || !selections.length){ return ''; }
      var parts = [];
      selections.forEach(function(group){
        if(!group || !group.items || !group.items.length){ return; }
        var itemTexts = group.items.map(function(option){
          var price = Number(option.price) || 0;
          if(price > 0){
            return option.name + '（+' + formatCurrency(price) + '）';
          }
          if(price < 0){
            return option.name + '（' + formatCurrency(price) + '）';
          }
          return option.name;
        });
        parts.push(group.name + '：' + itemTexts.join('、'));
      });
      return parts.join('；');
    }

    function buildOptionsStatusSummary(selections){
      if(!Array.isArray(selections) || !selections.length){ return ''; }
      var parts = [];
      selections.forEach(function(group){
        if(!group || !group.items || !group.items.length){ return; }
        var names = group.items.map(function(option){ return option.name; }).join('、');
        parts.push(group.name + '：' + names);
      });
      return parts.join('；');
    }

    function clearMealOptionsError(){
      $mealOptionsError.text('').addClass('is-hidden');
    }

    function showMealOptionsError(message){
      $mealOptionsError.text(message || '').removeClass('is-hidden');
    }

    function resetMealOptionsModal(){
      pendingMealForOptions = null;
      pendingMealOptionGroups = [];
      $mealOptionsName.text('');
      $mealOptionsGroups.empty();
      $mealOptionsSummaryBase.text(formatCurrency(0));
      $mealOptionsSummaryExtra.text(defaultMealOptionsExtraText);
      $mealOptionsSummaryTotal.text(formatCurrency(0));
      clearMealOptionsError();
    }

    function updateMealOptionsSummary(){
      var basePrice = pendingMealForOptions ? Number(pendingMealForOptions.money || 0) : 0;
      var extra = 0;
      $mealOptionsGroups.find('input:checked').each(function(){
        var groupIndex = parseInt($(this).attr('data-group-index'), 10);
        var optionIndex = parseInt($(this).attr('data-option-index'), 10);
        var group = pendingMealOptionGroups[groupIndex];
        if(!group){ return; }
        var option = group.items[optionIndex];
        if(!option){ return; }
        extra += Number(option.price) || 0;
      });
      $mealOptionsSummaryBase.text(formatCurrency(basePrice));
      if(extra > 0){
        $mealOptionsSummaryExtra.text('＋' + formatCurrency(extra));
      } else if(extra < 0){
        $mealOptionsSummaryExtra.text(formatCurrency(extra));
      } else {
        $mealOptionsSummaryExtra.text(defaultMealOptionsExtraText);
      }
      $mealOptionsSummaryTotal.text(formatCurrency(basePrice + extra));
    }

    function buildMealOptionGroups(groups){
      $mealOptionsGroups.empty();
      if(!groups.length){
        $mealOptionsGroups.append(
          $('<div class="meal-option-group__empty"/>').text('此餐點沒有額外選項。')
        );
        return;
      }
      groups.forEach(function(group, groupIndex){
        var $group = $('<div class="meal-option-group"/>').attr('data-index', groupIndex);
        var $header = $('<div class="meal-option-group__header"/>').appendTo($group);
        $('<div class="meal-option-group__name"/>').text(group.name).appendTo($header);
        var metaParts = [];
        metaParts.push(group.required ? '必選' : '可不選');
        metaParts.push(group.allowMultiple ? ('可選最多 ' + group.maxSelect + ' 項') : '限選 1 項');
        $('<div class="meal-option-group__meta"/>').text(metaParts.join('｜')).appendTo($header);

        var $items = $('<div class="meal-option-group__items"/>').appendTo($group);
        var inputName = 'mealOptionGroup' + groupIndex;
        var inputType = group.allowMultiple ? 'checkbox' : 'radio';

        group.items.forEach(function(option, optionIndex){
          var inputId = 'mealOption-' + groupIndex + '-' + optionIndex;
          var $label = $('<label class="meal-option-item"/>').attr('for', inputId);
          var $input = $('<input/>', {
            type: inputType,
            id: inputId,
            name: inputName
          }).attr('data-group-index', groupIndex).attr('data-option-index', optionIndex);
          var $info = $('<div class="meal-option-item__label"/>');
          $('<div class="meal-option-item__name"/>').text(option.name).appendTo($info);
          var price = Number(option.price) || 0;
          var priceText = price > 0 ? ('＋' + formatCurrency(price)) : (price < 0 ? formatCurrency(price) : '不加價');
          $('<div class="meal-option-item__price"/>').text(priceText).appendTo($info);
          $label.append($input).append($info);
          $items.append($label);
        });

        $mealOptionsGroups.append($group);
      });
    }

    function openMealOptionsModal(meal, groups){
      resetMealOptionsModal();
      pendingMealForOptions = meal;
      pendingMealOptionGroups = groups;
      $mealOptionsName.text(meal.name || '');
      buildMealOptionGroups(groups);
      clearMealOptionsError();
      updateMealOptionsSummary();
      $mealOptionsModal.addClass('is-active').attr('aria-hidden', 'false');
      setTimeout(function(){
        $mealOptionsContent.trigger('focus');
      }, 0);
    }

    function closeMealOptionsModal(){
      var wasActive = $mealOptionsModal.hasClass('is-active');
      $mealOptionsModal.removeClass('is-active').attr('aria-hidden', 'true');
      resetMealOptionsModal();
      if(wasActive){
        // Focus will return to main content automatically when meals rerender.
      }
    }

    function gatherMealOptionSelections(){
      if(!pendingMealOptionGroups.length){ return []; }
      var selections = [];
      var hasError = false;
      pendingMealOptionGroups.forEach(function(group, groupIndex){
        if(hasError){ return; }
        var $group = $mealOptionsGroups.find('.meal-option-group[data-index="' + groupIndex + '"]');
        var $checked = $group.find('input:checked');
        if(group.required && !$checked.length){
          showMealOptionsError('「' + group.name + '」為必選項目。');
          $group.find('input').first().trigger('focus');
          hasError = true;
          return;
        }
        if(!$checked.length){
          return;
        }
        var selectedItems = [];
        $checked.each(function(){
          var optionIndex = parseInt($(this).attr('data-option-index'), 10);
          var option = group.items[optionIndex];
          if(option){
            selectedItems.push({ name: option.name, price: Number(option.price) || 0 });
          }
        });
        if(selectedItems.length){
          selections.push({ name: group.name, items: selectedItems });
        }
      });
      if(hasError){ return null; }
      return selections;
    }

    function collectItemNotes(item){
      var notes = [];
      if(item.categoryName){ notes.push(item.categoryName); }
      if(item.element){ notes.push(item.element); }
      if(item.optionsNote){ notes.push(item.optionsNote); }
      return notes;
    }

    $mealOptionsCancel.on('click', function(){
      closeMealOptionsModal();
    });

    $mealOptionsClose.on('click', function(){
      closeMealOptionsModal();
    });

    $mealOptionsModal.on('click', function(event){
      if(event.target === this){
        closeMealOptionsModal();
      }
    });

    $mealOptionsConfirm.on('click', function(){
      if(!pendingMealForOptions){
        closeMealOptionsModal();
        return;
      }
      var selections = gatherMealOptionSelections();
      if(selections === null){
        return;
      }
      var meal = pendingMealForOptions;
      closeMealOptionsModal();
      addMealToCart(meal, selections);
    });

    $mealOptionsModal.on('change', '.meal-option-group input', function(){
      clearMealOptionsError();
      var groupIndex = parseInt($(this).attr('data-group-index'), 10);
      var group = pendingMealOptionGroups[groupIndex];
      if(group && group.allowMultiple){
        var $group = $mealOptionsGroups.find('.meal-option-group[data-index="' + groupIndex + '"]');
        var checkedCount = $group.find('input:checked').length;
        if(group.maxSelect && checkedCount > group.maxSelect){
          this.checked = false;
          showMealOptionsError('「' + group.name + '」最多可選 ' + group.maxSelect + ' 項。');
        }
      }
      updateMealOptionsSummary();
    });

    function renderCart(){
      var totalAmount = 0;
      var totalQty = 0;

      $cartList.empty();

      cartItems.forEach(function(item, index){
        var price = Number(item.price) || 0;
        var subtotal = price * item.qty;
        totalAmount += subtotal;
        totalQty += item.qty;

        var $item = $('<div class="cart-item"/>');
        var $header = $('<div class="cart-item-header"/>').appendTo($item);
        $('<div class="cart-item-name"/>').text(item.name).appendTo($header);
        $('<div class="cart-item-price"/>').text('單價 ' + formatCurrency(price)).appendTo($header);

        var notes = collectItemNotes(item);
        if(notes.length){
          $('<div class="cart-item-note"/>').text(notes.join('｜')).appendTo($header);
        }

        var $actions = $('<div class="cart-item-actions"/>').appendTo($item);
        var $qty = $('<div class="cart-item-qty" aria-label="數量調整"/>').appendTo($actions);
        $('<button type="button" class="cart-qty-btn" aria-label="減少一份">−</button>')
          .on('click', function(){ changeCartItemQuantity(index, -1); })
          .appendTo($qty);
        $('<span class="cart-item-qty-value"/>').text(item.qty).appendTo($qty);
        $('<button type="button" class="cart-qty-btn" aria-label="增加一份">＋</button>')
          .on('click', function(){ changeCartItemQuantity(index, 1); })
          .appendTo($qty);

        $('<div class="cart-item-subtotal"/>').text('小計 ' + formatCurrency(subtotal)).appendTo($actions);
        $('<button type="button" class="cart-remove">移除</button>')
          .on('click', function(){ removeCartItem(index); })
          .appendTo($actions);

        $cartList.append($item);
      });

      var hasItems = totalQty > 0;
      $cartSummary.text(hasItems ? ('共 ' + totalQty + ' 份餐點') : '尚未選擇餐點');
      $cartEmpty.toggleClass('is-hidden', hasItems);
      $clearCart.prop('disabled', !hasItems);
      $cartTotal.text(formatCurrency(totalAmount));

      if($sendCount.length){
        $sendCount.text(totalQty);
        $sendCount.toggleClass('is-hidden', !hasItems);
      }

      updateSendButtonState();

      if($orderConfirmModal.hasClass('is-active') || isReceiveEmbedded){
        renderOrderConfirmContent();
      }
    }

    function renderOrderConfirmContent(){
      var detailParts = [];
      if(currentMode === ORDER_MODE_TAKEOUT){
        if(currentTakeoutShop && (currentTakeoutShop.name || currentTakeoutShop.rawId)){
          detailParts.push('餐廳：' + (currentTakeoutShop.name || currentTakeoutShop.rawId));
        }
        var takeoutCode = $.trim($takeoutCodeInput.val() || '');
        if(takeoutCode){
          detailParts.push('外帶碼：' + takeoutCode);
        }
        if(!detailParts.length){
          detailParts.push('外帶資訊尚未提供');
        }
      } else {
        if(currentTable){
          if(currentTable.shopName || currentTable.shopId){
            detailParts.push('餐廳：' + (currentTable.shopName || currentTable.shopId));
          }
          if(currentTable.number !== undefined && currentTable.number !== null){
            var zoneText = currentTable.zone ? ('（' + currentTable.zone + '）') : '';
            detailParts.push('桌號：' + currentTable.number + zoneText);
          }
        }
        if(!detailParts.length){
          detailParts.push('桌號資訊尚未提供');
        }
      }
      var detailText = detailParts.join('　');
      if($orderConfirmTable.length){
        $orderConfirmTable.text(detailText);
      }
      if($orderReviewInfo.length){
        $orderReviewInfo.text(detailText);
      }

      function renderSummary($items, $total, $submit){
        if(!$items.length && !$total.length && !$submit.length){ return; }

        $items.empty();

        if(!cartItems.length){
          if($items.length){
            $items.append(
              $('<tr class="order-confirm-empty"/>').append(
                $('<td/>').attr('colspan', 3).text('目前尚未選擇餐點。')
              )
            );
          }
          if($total.length){
            $total.text('總計：' + formatCurrency(0) + '（共 0 份）');
          }
          if($submit.length){
            if(isSubmitting){
              $submit.prop('disabled', true);
            } else {
              $submit.prop('disabled', true);
              if($submit.is($confirmSubmit)){
                $submit.text(confirmSubmitDefaultText);
              } else if($submit.is($orderReviewSubmit)){
                $submit.text(orderReviewSubmitDefaultText);
              }
            }
          }
          return;
        }

        var totalAmount = 0;
        var totalQty = 0;

        cartItems.forEach(function(item, index){
          var price = Number(item.price) || 0;
          var subtotal = price * item.qty;
          totalAmount += subtotal;
          totalQty += item.qty;

          var $row = $('<tr/>').attr('data-index', index);
          var $nameCell = $('<td/>').appendTo($row);
          $('<div class="order-confirm-name"/>').text(item.name).appendTo($nameCell);
          var confirmNotes = collectItemNotes(item);
          if(confirmNotes.length){
            $('<div class="order-confirm-note"/>').text(confirmNotes.join('｜')).appendTo($nameCell);
          }

          var $qtyCell = $('<td/>').appendTo($row);
          var $qtyControl = $('<div class="order-confirm-qty" role="group"/>')
            .attr('aria-label', '調整 ' + item.name + ' 數量')
            .appendTo($qtyCell);
          $('<button type="button" class="order-confirm-qty-btn" aria-label="減少一份" data-delta="-1">−</button>')
            .appendTo($qtyControl);
          $('<span class="order-confirm-qty-value"/>').text(item.qty).appendTo($qtyControl);
          $('<button type="button" class="order-confirm-qty-btn" aria-label="增加一份" data-delta="1">＋</button>')
            .appendTo($qtyControl);

          var $subtotalCell = $('<td/>').appendTo($row);
          $('<span class="order-confirm-subtotal-value"/>').text(formatCurrency(subtotal)).appendTo($subtotalCell);
          $('<button type="button" class="order-confirm-remove">移除</button>').appendTo($subtotalCell);

          $items.append($row);
        });

        if($total.length){
          $total.text('總計：' + formatCurrency(totalAmount) + '（共 ' + totalQty + ' 份）');
        }

        if($submit.length){
          if(isSubmitting){
            $submit.prop('disabled', true);
          } else {
            $submit.prop('disabled', false);
            if($submit.is($confirmSubmit)){
              $submit.text(confirmSubmitDefaultText);
            } else if($submit.is($orderReviewSubmit)){
              $submit.text(orderReviewSubmitDefaultText);
            }
          }
        }
      }

      renderSummary($orderConfirmItems, $orderConfirmTotal, $confirmSubmit);
      renderSummary($orderReviewItems, $orderReviewTotal, $orderReviewSubmit);
    }

    function updateSendButtonState(){
      var canSend = false;
      if(currentMode === ORDER_MODE_TAKEOUT){
        canSend = !!(currentTakeoutShop && currentTakeoutShop.id && cartItems.length);
      } else {
        canSend = !!(currentTable && currentTable.shopId && cartItems.length);
      }
      $sendButton.prop('disabled', !canSend);
    }

    function closeOrderConfirmModal(){
      var wasActive = $orderConfirmModal.hasClass('is-active');
      $orderConfirmModal.removeClass('is-active').attr('aria-hidden', 'true');
      $confirmSubmit.prop('disabled', false).text(confirmSubmitDefaultText);
      isSubmitting = false;
      if(wasActive){
        $sendButton.trigger('focus');
      }
    }

    function openOrderConfirmModal(){
      if(!$orderConfirmModal.length){ return; }

      isSubmitting = false;

      renderOrderConfirmContent();

      $orderConfirmModal.addClass('is-active').attr('aria-hidden', 'false');
      setTimeout(function(){
        $orderConfirmContent.trigger('focus');
      }, 0);
    }

    function cartItemMatchesMeal(item, meal){
      if(item.mealId && meal.id){
        return item.mealId === meal.id;
      }
      var basePrice = Number(meal.money || 0);
      return !item.mealId && !meal.id && item.name === meal.name && item.basePrice === basePrice;
    }

    function getCartQtyForMeal(meal){
      var totalQty = 0;
      cartItems.forEach(function(item){
        if(cartItemMatchesMeal(item, meal)){
          totalQty += item.qty;
        }
      });
      return totalQty;
    }


    function changeCartItemQuantity(index, delta){
      if(index < 0 || index >= cartItems.length){ return; }
      var item = cartItems[index];
      var nextQty = item.qty + delta;
      if(nextQty <= 0){
        cartItems.splice(index, 1);
      } else {
        item.qty = nextQty;
      }
      renderMeals();
    }

    function removeCartItem(index){
      if(index < 0 || index >= cartItems.length){ return; }
      cartItems.splice(index, 1);
      renderMeals();
      notifyCartStatus('已從購物車移除餐點。', '');
    }

    function clearCart(options){
      var skipStatus = options && options.skipStatus;
      if(!cartItems.length){

        renderMeals();
        return;
      }
      cartItems = [];

      renderMeals();
      if(!skipStatus){
        notifyCartStatus('購物車已清空。', '');
      }
    }

    function addMealToCart(meal, optionSelections){
      var selectionsClone = cloneOptionSelections(optionSelections || []);
      var basePrice = Number(meal.money || 0);
      var optionsExtra = calculateOptionsExtra(selectionsClone);
      var unitPrice = basePrice + optionsExtra;
      var optionsKey = buildOptionsKey(selectionsClone);
      var existing = null;
      cartItems.some(function(item){
        if(cartItemMatchesMeal(item, meal) && (item.optionsKey || '') === optionsKey){
          existing = item;
          return true;
        }
        return false;
      });

      if(existing){
        existing.qty += 1;
        existing.price = unitPrice;
        existing.basePrice = basePrice;
        existing.optionsTotal = optionsExtra;
        existing.selectedOptions = selectionsClone;
        existing.optionsNote = buildOptionsNote(selectionsClone);
        existing.optionsKey = optionsKey;
      } else {
        cartItems.push({
          mealId: meal.id || null,
          name: meal.name,
          price: unitPrice,
          basePrice: basePrice,
          qty: 1,
          categoryName: meal.categoryName || '',
          element: meal.element || '',
          optionsKey: optionsKey,
          optionsTotal: optionsExtra,
          selectedOptions: selectionsClone,
          optionsNote: buildOptionsNote(selectionsClone)
        });
      }

      renderMeals();
      var statusMessage = '已加入餐點：' + meal.name;
      var summary = buildOptionsStatusSummary(selectionsClone);
      if(summary){
        statusMessage += '（' + summary + '）';
      }
      notifyCartStatus(statusMessage, 'success');
    }

    function handleAddMealClick(meal){
      var groups = getMealOptionGroups(meal) || [];
      if(groups.length){
        openMealOptionsModal(meal, groups);
      } else {
        addMealToCart(meal, []);
      }
    }

    function isSameCategory(a, b){
      return (a || '') === (b || '');
    }

    function setCategories(categories){
      allCategories = categories || [];
      if(activeCategoryId && !allCategories.some(function(c){ return isSameCategory(c.id, activeCategoryId); })){
        activeCategoryId = null;
      }
      renderCategories();
    }

    function renderCategories(){
      var $container = $('#mealCategories').empty();
      var hasContext = false;
      if(currentMode === ORDER_MODE_TAKEOUT){
        hasContext = !!(currentTakeoutShop && currentTakeoutShop.id);
        if(!hasContext){
          $container.append($('<div class="meal-categories-empty"/>').text('請先輸入店家代碼以顯示分類。'));
          return;
        }
      } else {
        hasContext = !!(currentTable || initialTable);
        if(!hasContext){
          $container.append($('<div class="meal-categories-empty"/>').text('請先選擇桌號以顯示分類。'));
          return;
        }
      }

      if(!allCategories.length){
        $container.append($('<div class="meal-categories-empty"/>').text('此餐廳尚無設定分類。'));
        return;
      }

      var $list = $('<div class="meal-categories-list"/>');
      var items = [{ id: null, name: '全部' }].concat(allCategories);
      items.forEach(function(cat){
        var isActive = (!cat.id && !activeCategoryId) || (cat.id && isSameCategory(cat.id, activeCategoryId));
        var $btn = $('<button type="button" class="meal-category-btn"/>')
          .toggleClass('active', !!isActive)
          .text(cat.name)
          .on('click', function(){
            if(isActive){ return; }
            activeCategoryId = cat.id || null;
            renderCategories();
            renderMeals();
          });
        $list.append($btn);
      });

      $container.append($list);
    }

    function setMeals(meals){
      allMeals = meals || [];
      renderMeals();
    }

    function clearTableSelection(options){
      var opts = options || {};
      currentTable = null;
      initialTable = null;
      initialMeals = [];
      initialCategories = [];
      currentMealsShopId = null;
      setTableDetail('');
      if(!opts.skipMessage){
        setTableStatus(defaultTableStatus, '');
      }
      updatePageTitle(null);
      clearCart({ skipStatus: true });
      setCategories([]);
      setMeals([]);
      updateSendButtonState();
    }

    function clearTakeoutSelection(options){
      var opts = options || {};
      currentTakeoutShop = null;
      if(!opts.keepMeals){
        initialMeals = [];
        initialCategories = [];
        currentMealsShopId = null;
        setCategories([]);
        setMeals([]);
        clearCart({ skipStatus: true });
      }
      setTakeoutStatus(defaultTakeoutStatus, '');
      setTakeoutDetail('');
      updateTakeoutTitle(null);
      updateSendButtonState();
    }

    function lookupTable(number){
      var trimmed = $.trim(number || '');
      if(!trimmed){
        clearTableSelection();
        return;
      }

      var num = parseInt(trimmed, 10);
      if(!isFinite(num) || num <= 0){
        clearTableSelection();
        setTableStatus('桌號必須為正整數。', 'error');
        return;
      }

      setTableStatus('查詢中…', '');
      clearTableSelection({ skipMessage: true });

      $.getJSON(lookupUrl, { number: num })
        .done(function(res){
          if(res && res.ok){
            currentTable = res;
            initialTable = res;
            var zoneText = res.zone ? ('（' + res.zone + '）') : '';
            var detail = '餐廳：' + (res.shopName || res.shopId) + '　桌號：' + res.number + zoneText;
            setTableStatus('已連線至桌號 ' + res.number + zoneText + '。', 'success');
            setTableDetail(detail);
            updatePageTitle(currentTable);
            clearTakeoutSelection({ keepMeals: true });
            clearCart({ skipStatus: true });
            setOrderMode(ORDER_MODE_DINE_IN);
          } else {
            var msg = res && res.error ? res.error : '查無對應桌號。';
            setTableStatus(msg, 'error');
          }
        })
        .fail(function(xhr){
          var msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '查詢時發生錯誤。';
          setTableStatus(msg, 'error');
        });
    }

    function connectTakeoutShop(shopId){
      var trimmed = $.trim(shopId || '');
      if(!trimmed){
        clearTakeoutSelection();
        return;
      }

      setTakeoutStatus('查詢中…', '');

      $.getJSON(shopInfoUrl, { id: trimmed })
        .done(function(res){
          if(res && res.ok && res.shop && res.shop.id){
            currentTakeoutShop = {
              id: res.shop.id,
              rawId: res.shop.id,
              name: res.shop.name || ''
            };
            setTakeoutStatus('已連線至店家。', 'success');
            setTakeoutDetail('餐廳：' + (currentTakeoutShop.name || currentTakeoutShop.rawId));
            updateTakeoutTitle(currentTakeoutShop);
            clearTableSelection({ skipMessage: true });
            clearCart({ skipStatus: true });
            setOrderMode(ORDER_MODE_TAKEOUT);
          } else {
            var msg = res && res.error ? res.error : '沒有此店家';
            clearTakeoutSelection();
            setTakeoutStatus(msg, 'error');
          }
        })
        .fail(function(xhr){
          var msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '查詢店家時發生錯誤。';
          clearTakeoutSelection();
          setTakeoutStatus(msg, 'error');
        });
    }

    $orderModeButtons.on('click', function(){
      var mode = $(this).data('order-mode');
      setOrderMode(mode);
    });

    $tableForm.on('submit', function(event){
      event.preventDefault();
      lookupTable($tableInput.val());
    });

    $takeoutForm.on('submit', function(event){
      event.preventDefault();
      connectTakeoutShop($takeoutInput.val());
    });

    function renderMeals(){
      renderCart();
      var $list = $('#mealList').empty();
      var hasContext = false;
      if(currentMode === ORDER_MODE_TAKEOUT){
        hasContext = !!(currentTakeoutShop && currentTakeoutShop.id);
        if(!hasContext){
          $list.append($('<div class="meal-empty"/>').text('請先輸入店家代碼以顯示餐點。'));
          return;
        }
      } else {
        hasContext = !!(currentTable || initialTable);
        if(!hasContext){
          $list.append($('<div class="meal-empty"/>').text('請先選擇桌號以顯示餐點。'));
          return;
        }
      }

      if(!allMeals.length){
        $list.append($('<div class="meal-empty"/>').text('此餐廳目前沒有可顯示的餐點。'));
        return;
      }

      var mealsToShow = !activeCategoryId ? allMeals : allMeals.filter(function(m){
        return isSameCategory(m.categoryId, activeCategoryId);
      });

      if(!mealsToShow.length){
        $list.append($('<div class="meal-empty"/>').text('此分類目前沒有餐點。'));
        return;
      }

      mealsToShow.forEach(function(m){
        var $card = $('<div class="meal-card"/>');
        $card.append($('<div class="meal-name"/>').text(m.name));
        if(m.categoryName){
          $card.append($('<div class="meal-category-label"/>').text(m.categoryName));
        }
        $card.append($('<div class="meal-price"/>').text(formatCurrency(m.money)));
        if(m.element){
          $card.append($('<div class="meal-element"/>').text(m.element));
        }
        var $btn = $('<button type="button"/>')
          .text('加入購物車')
          .on('click', function(){
            handleAddMealClick(m);
          });
        $card.append($btn);

        var qty = getCartQtyForMeal(m);
        if(qty > 0){
          $card.addClass('selected');
          $card.append($('<div class="meal-cart-indicator"/>').text('購物車中已有 ' + qty + ' 份。'));
        }

        $list.append($card);
      });
    }

    function fetchMealsForShop(shopId, options){
      options = options || {};
      var onError = typeof options.onError === 'function' ? options.onError : function(msg){ setTableStatus(msg, 'error'); };
      var onSuccess = typeof options.onSuccess === 'function' ? options.onSuccess : function(){};

      if(!shopId){
        initialCategories = [];
        initialMeals = [];
        currentMealsShopId = null;
        setCategories([]);
        setMeals([]);
        clearCart({ skipStatus: true });
        onError('尚未選擇店家。');
        return;
      }

      $.getJSON(mealLookupUrl, { shopId: shopId })
        .done(function(res){
          if(res && res.ok){
            initialCategories = res.categories || [];
            initialMeals = res.items || [];
            currentMealsShopId = String(shopId);
            clearCart({ skipStatus: true });
            setCategories(initialCategories);
            setMeals(initialMeals);
            onSuccess(res);
          } else {
            var msg = res && res.error ? res.error : '載入餐點失敗。';
            initialCategories = [];
            initialMeals = [];
            currentMealsShopId = null;
            setCategories([]);
            setMeals([]);
            clearCart({ skipStatus: true });
            onError(msg);
          }
        })
        .fail(function(xhr){
          var msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '載入餐點時發生錯誤。';
          initialCategories = [];
          initialMeals = [];
          currentMealsShopId = null;
          setCategories([]);
          setMeals([]);
          clearCart({ skipStatus: true });
          onError(msg);
        });
    }

    $clearCart.on('click', function(){
      clearCart({ skipStatus: false });
    });

    if($orderReviewItems.length){
      $orderReviewItems.on('click', '.order-confirm-qty-btn', function(){
        var delta = parseInt($(this).attr('data-delta'), 10);
        var index = parseInt($(this).closest('tr').data('index'), 10);
        if(!isFinite(delta) || !isFinite(index)){ return; }
        changeCartItemQuantity(index, delta);
      });

      $orderReviewItems.on('click', '.order-confirm-remove', function(){
        var index = parseInt($(this).closest('tr').data('index'), 10);
        if(!isFinite(index)){ return; }
        removeCartItem(index);
      });
    }

    function tryFillFromQuery(){
      if(initialTable){ return; }
      var params = new URLSearchParams(window.location.search);
      var tableVal = params.get('table') || params.get('tableNumber');
      var shopVal = params.get('shop') || params.get('shopId');
      if(tableVal){
        lookupTable(tableVal);
        return;
      }
      if(shopVal){
        connectTakeoutShop(shopVal);
      }
    }

    $orderConfirmClose.on('click', function(){
      closeOrderConfirmModal();
    });

    $orderConfirmModal.on('click', function(event){
      if(event.target === this){
        closeOrderConfirmModal();
      }
    });

    $orderConfirmItems.on('click', '.order-confirm-qty-btn', function(){
      var delta = parseInt($(this).attr('data-delta'), 10);
      var index = parseInt($(this).closest('tr').data('index'), 10);
      if(!isFinite(delta) || !isFinite(index)){ return; }
      changeCartItemQuantity(index, delta);
    });

    $orderConfirmItems.on('click', '.order-confirm-remove', function(){
      var index = parseInt($(this).closest('tr').data('index'), 10);
      if(!isFinite(index)){ return; }
      removeCartItem(index);
    });

    $(document).on('keydown', function(event){
      if(event.key === 'Escape'){
        if($mealOptionsModal.hasClass('is-active')){
          closeMealOptionsModal();
          return;
        }
        if($orderConfirmModal.hasClass('is-active')){
          closeOrderConfirmModal();
        }
      }
    });

    hub.client.orderChanged = function(payload){
      console.log('orderChanged', payload);

      var modeForStatus = pendingSubmitMode || currentMode;

      if(!payload){
        isSubmitting = false;
        $confirmSubmit.prop('disabled', false).text(confirmSubmitDefaultText);
        if($orderReviewSubmit.length){
          $orderReviewSubmit.prop('disabled', false).text(orderReviewSubmitDefaultText);
        }
        setStatusForMode(modeForStatus, '訂單處理結果不明，請重新嘗試。', 'error');
        pendingSubmitMode = null;
        return;
      }

      if(payload.type === 'error'){
        isSubmitting = false;
        $confirmSubmit.prop('disabled', false).text(confirmSubmitDefaultText);
        if($orderReviewSubmit.length){
          $orderReviewSubmit.prop('disabled', false).text(orderReviewSubmitDefaultText);
        }
        var message = payload.error || '送出訂單時發生錯誤，請稍後再試。';
        setStatusForMode(modeForStatus, message, 'error');
        pendingSubmitMode = null;
        return;
      }

      if(payload.type === 'created'){
        var totalQty = 0;
        if(payload.dto && Array.isArray(payload.dto.items)){
          totalQty = payload.dto.items.reduce(function(sum, item){
            var qty = item && item.qty ? Number(item.qty) : 0;
            return sum + (isFinite(qty) ? qty : 0);
          }, 0);
        }

        setStatusForMode(modeForStatus, '已送出訂單，共 ' + totalQty + ' 份餐點。', 'success');
        clearCart({ skipStatus: true });
        updateSendButtonState();
        closeOrderConfirmModal();
        if($orderReviewSubmit.length){
          $orderReviewSubmit.prop('disabled', false).text(orderReviewSubmitDefaultText);
        }
        pendingSubmitMode = null;
        return;
      }

      isSubmitting = false;
      $confirmSubmit.prop('disabled', false).text(confirmSubmitDefaultText);
      if($orderReviewSubmit.length){
        $orderReviewSubmit.prop('disabled', false).text(orderReviewSubmitDefaultText);
      }
      pendingSubmitMode = null;
    };

    function applyInitialTable(){
      if(initialTable){
        currentTable = initialTable;
        var zoneText = initialTable.zone ? ('（' + initialTable.zone + '）') : '';
        var detail = '餐廳：' + (initialTable.shopName || initialTable.shopId) + '　桌號：' + initialTable.number + zoneText;
        currentMealsShopId = String(initialTable.shopId || '');
        setOrderMode(ORDER_MODE_DINE_IN);
        setTableStatus('已連線至桌號 ' + initialTable.number + zoneText + '。', 'success');
        setTableDetail(detail);
        updatePageTitle(initialTable);
        setTakeoutStatus(defaultTakeoutStatus, '');
        setTakeoutDetail('');
      } else if(initialError){
        setOrderMode(ORDER_MODE_DINE_IN);
        setStatusForMode(ORDER_MODE_DINE_IN, initialError, 'error');
        setTableDetail('');
        updatePageTitle(null);
        setTakeoutStatus(defaultTakeoutStatus, '');
        setTakeoutDetail('');
      } else {
        setOrderMode(ORDER_MODE_DINE_IN);
        setTableStatus(defaultTableStatus, '');
        setTableDetail('');
        updatePageTitle(null);
        setTakeoutStatus(defaultTakeoutStatus, '');
        setTakeoutDetail('');
      }
    }

    applyInitialTable();
    setCategories(initialCategories);
    setMeals(initialMeals);
    updateSendButtonState();

    if(isReceiveEmbedded){
      renderOrderConfirmContent();
    }

    function submitOrder(){
      if(isSubmitting){ return; }

      if(currentMode === ORDER_MODE_TAKEOUT){
        if(!currentTakeoutShop || !currentTakeoutShop.id){
          setTakeoutStatus('請先輸入有效的店家代碼。', 'error');
          if(!isReceiveEmbedded){
            closeOrderConfirmModal();
          }
          return;
        }
      } else {
        if(!currentTable || !currentTable.shopId){
          setTableStatus('請先查詢有效的桌號後再下單。', 'error');
          if(!isReceiveEmbedded){
            closeOrderConfirmModal();
          }
          return;
        }
      }

      if(!cartItems.length){
        setStatusForMode(currentMode, '請先將餐點加入購物車。', 'error');
        if(!isReceiveEmbedded){
          closeOrderConfirmModal();
        }
        return;
      }

      isSubmitting = true;
      $confirmSubmit.prop('disabled', true).text('送出中…');
      if($orderReviewSubmit.length){
        $orderReviewSubmit.prop('disabled', true).text('送出中…');
      }

      var missingMealId = cartItems.some(function(item){ return !item.mealId; });
      if(missingMealId){
        isSubmitting = false;
        $confirmSubmit.prop('disabled', false).text(confirmSubmitDefaultText);
        if($orderReviewSubmit.length){
          $orderReviewSubmit.prop('disabled', false).text(orderReviewSubmitDefaultText);
        }
        setStatusForMode(currentMode, '餐點資料缺少，請重新選擇餐點。', 'error');
        if(!isReceiveEmbedded){
          closeOrderConfirmModal();
        }
        return;
      }

      var dto;
      if(currentMode === ORDER_MODE_TAKEOUT){
        var takeoutCode = $.trim($takeoutCodeInput.val() || '');
        dto = {
          shopId: currentTakeoutShop.id,
          shopName: currentTakeoutShop.name,
          tableId: null,
          tableNumber: null,
          tableZone: null,
          takeoutCode: takeoutCode || null,
          orderType: 'Takeout',
          notes: null,
          items: cartItems.map(function(item){
            var note = (item.optionsNote || '').trim();
            return { mealId: item.mealId, name: item.name, qty: item.qty, price: item.price, notes: note || null };
          })
        };
      } else {
        dto = {
          shopId: currentTable.shopId,
          shopName: currentTable.shopName,
          tableId: currentTable.tableId,
          tableNumber: currentTable.number,
          tableZone: currentTable.zone,
          takeoutCode: null,
          orderType: 'DineIn',
          notes: null,
          items: cartItems.map(function(item){
            var note = (item.optionsNote || '').trim();
            return { mealId: item.mealId, name: item.name, qty: item.qty, price: item.price, notes: note || null };
          })
        };
      }

      pendingSubmitMode = currentMode;

      hub.server.createOrder(dto)
        .done(function(){
          // 成功處理由 hub.client.orderChanged 接手
        })
        .fail(function(){
          isSubmitting = false;
          $confirmSubmit.prop('disabled', false).text(confirmSubmitDefaultText);
          if($orderReviewSubmit.length){
            $orderReviewSubmit.prop('disabled', false).text(orderReviewSubmitDefaultText);
          }
          setStatusForMode(currentMode, '送出訂單時發生錯誤，請稍後再試。', 'error');
          if(!isReceiveEmbedded){
            closeOrderConfirmModal();
          }
        });

      setStatusForMode(currentMode, '訂單送出中，請稍候…', '');
    }

    $.connection.hub.start().done(function(){
      if(initialTable && initialTable.shopId){
        currentMealsShopId = String(initialTable.shopId || '');
      } else {
        tryFillFromQuery();
      }

      if(!isReceiveEmbedded && $sendButton.length){
        $sendButton.on('click', function(){
          if(currentMode === ORDER_MODE_TAKEOUT){
            if(!currentTakeoutShop || !currentTakeoutShop.id){
              setTakeoutStatus('請先輸入有效的店家代碼。', 'error');
              return;
            }
          } else {
            if(!currentTable || !currentTable.shopId){
              setTableStatus('請先查詢有效的桌號後再下單。', 'error');
              return;
            }
          }

          if(!cartItems.length){
            setStatusForMode(currentMode, '請先將餐點加入購物車。', 'error');
            return;
          }

          openOrderConfirmModal();
        });
      }

      $confirmSubmit.on('click', function(){
        submitOrder();
      });

      if($orderReviewSubmit.length){
        $orderReviewSubmit.on('click', function(){
          renderOrderConfirmContent();
          submitOrder();
        });
      }
    }).fail(function(){
      setTableStatus('SignalR 連線失敗，請重新整理頁面。', 'error');
    });
  })();
    </script>
</body>
</html>
