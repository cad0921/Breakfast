@model BreakFastShop.Models.OrderPageViewModel
@using System.Linq
@using System.Web.Helpers
@{
    Layout = null;
    var tablePayload = Model?.Table == null ? null : new
    {
        tableId = Model.Table.Id,
        number = Model.Table.Number,
        shopId = Model.Table.ShopId,
        shopName = Model.Table.ShopName,
        zone = Model.Table.Zone
    };
    var mealsPayload = Model?.Meals?
        .Select(m => (object)new { id = m.Id, name = m.Name, money = m.Money, element = m.Element, categoryId = m.CategoryId, categoryName = m.CategoryName })
        .ToList() ?? new List<object>();
    var categoriesPayload = Model?.Categories?
        .Select(c => (object)new { id = c.Id, name = c.Name })
        .ToList() ?? new List<object>();
    var errorMessage = Model?.Error;
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>下單頁</title>
    <script src="~/Scripts/jquery-3.7.0.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <style>
        body {
            font-family: system-ui, "Noto Sans TC", sans-serif;
            margin: 2rem;
            background: #f8f9fa;
        }

        h1 {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin: .5rem 0 .25rem;
            font-weight: 600;
        }

        input,
        textarea {
            width: 100%;
            padding: .5rem;
            border: 1px solid #ced4da;
            border-radius: .375rem;
            font-size: 1rem;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
        }

        button {
            border: none;
            border-radius: .375rem;
            cursor: pointer;
        }

        .table-input {
            display: flex;
            gap: .5rem;
            align-items: center;
            margin-bottom: .25rem;
        }

        .table-input input {
            flex: 1;
        }

        .table-input button {
            padding: .5rem 1rem;
            background: #0d6efd;
            color: #fff;
        }

        .table-status {
            margin-bottom: .75rem;
            font-size: .95rem;
            color: #555;
            min-height: 1.5rem;
        }

        .table-status.error {
            color: #b21f1f;
        }

        .table-status.success {
            color: #0f5132;
        }

        #send {
            padding: .75rem 1.5rem;
            background: #198754;
            color: #fff;
            font-size: 1rem;
            width: 100%;
        }

        #log {
            background: #fff;
            border: 1px solid #ddd;
            padding: 1rem;
            width: 100%;
            height: 14rem;
            overflow: auto;
            border-radius: .375rem;
            box-sizing: border-box;
        }

        .order-panel #log {
            margin-top: 1.5rem;
        }

        .order-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .order-panel {
            flex: 1 1 320px;
            max-width: 420px;
            background: #fff;
            padding: 1.5rem;
            border-radius: .5rem;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .order-fields {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .table-summary,
        .meal-selection-status {
            padding: .75rem 1rem;
            border-radius: .5rem;
            background: #f8f9fa;
            color: #495057;
            line-height: 1.5;
        }

        .meal-selection-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .meal-selection-status button {
            flex-shrink: 0;
        }

        .order-submit {
            margin-top: auto;
            padding-top: 1.5rem;
        }

        .meal-panel {
            flex: 1 1 320px;
            min-width: 280px;
        }

        .meal-panel h2 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .meal-categories {
            margin-bottom: 1rem;
        }

        .meal-categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
        }

        .meal-categories-empty {
            color: #6c757d;
            font-style: italic;
            background: #fff;
            border: 1px dashed #ced4da;
            padding: .75rem 1rem;
            border-radius: .5rem;
            text-align: center;
        }

        .meal-category-btn {
            padding: .5rem 1rem;
            background: #e9ecef;
            color: #212529;
            border: 1px solid transparent;
            border-radius: 999px;
            font-size: .95rem;
            transition: all .2s ease;
        }

        .meal-category-btn:hover,
        .meal-category-btn:focus {
            background: #d1e7ff;
            color: #0d6efd;
        }

        .meal-category-btn.active {
            background: #0d6efd;
            color: #fff;
            border-color: #0a58ca;
            box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.2);
        }

        .meal-list {
            display: flex;
            flex-direction: column;
            gap: .75rem;
        }

        .meal-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: .5rem;
            padding: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
        }

        .meal-card.selected {
            border-color: #0d6efd;
            box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.2);
        }

        .meal-card.selected .meal-name {
            color: #0d6efd;
        }

        .meal-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .meal-price {
            margin-top: .25rem;
            color: #0f5132;
            font-weight: 600;
        }

        .meal-element {
            margin-top: .35rem;
            color: #6c757d;
            font-size: .9rem;
            white-space: pre-wrap;
        }

        .meal-category-label {
            display: inline-block;
            margin-top: .35rem;
            padding: .25rem .5rem;
            background: #e7f1ff;
            color: #0d6efd;
            border-radius: .375rem;
            font-size: .85rem;
        }

        .meal-card button {
            margin-top: .75rem;
            padding: .5rem 1rem;
            background: #0d6efd;
            color: #fff;
            font-size: .95rem;
        }

        .meal-card button:disabled {
            background: #6c757d;
            cursor: default;
        }

        .meal-empty {
            color: #6c757d;
            font-style: italic;
            background: #fff;
            border: 1px dashed #ced4da;
            padding: 1rem;
            border-radius: .5rem;
            text-align: center;
        }

        @@media (max-width: 768px) {
            body {
                margin: 1.25rem;
            }

            .order-panel {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>下單頁</h1>
    <div class="order-layout">
        <section class="order-panel">
            <div class="order-fields">
                <div>
                    <label>桌號</label>
                    <div class="table-input">
                        <input id="tableNumber" type="number" min="1" placeholder="請輸入桌號">
                        <button id="lookupTable" type="button">查詢桌號</button>
                    </div>
                </div>
                <div class="table-status" id="tableStatus">請輸入桌號後按查詢。</div>
                <div class="table-summary" id="tableSummary" style="display:none;"></div>
                <div class="meal-selection-status" id="mealSelection">
                    <span id="selectedMealText">尚未選擇餐點。</span>
                    <button id="clearMeal" type="button" style="display:none;">清除選擇</button>
                </div>
            </div>
            <pre id="log"></pre>
            <div class="order-submit">
                <button id="send">送出訂單</button>
            </div>
        </section>
        <aside class="meal-panel">
            <h2>餐點列表</h2>
            <div class="meal-categories" id="mealCategories"></div>
            <div class="meal-list" id="mealList"></div>
        </aside>
    </div>
    <script>
  var hub = $.connection.ordersHub;
  var lookupUrl = '@Url.Action("TableInfo","Home")';
  var mealLookupUrl = '@Url.Action("ShopMeals","Home")';
  var currentTable = null;
  var initialTable = @Html.Raw(Json.Encode(tablePayload));
  var initialMeals = @Html.Raw(Json.Encode(mealsPayload));
  var initialCategories = @Html.Raw(Json.Encode(categoriesPayload));
  var initialError = @Html.Raw(Json.Encode(errorMessage));
  var allMeals = [];
  var allCategories = [];
  var activeCategoryId = null;
  var selectedMeal = null;

  function setTableStatus(message, type){
    var $status = $('#tableStatus');
    $status.removeClass('error success');
    if(type === 'error'){ $status.addClass('error'); }
    if(type === 'success'){ $status.addClass('success'); }
    $status.text(message);
  }

  function log(message){
    $('#log').append(message+'\n');
  }

  function isSameCategory(a, b){
    return (a || '') === (b || '');
  }

  function setCategories(categories){
    allCategories = categories || [];
    if(activeCategoryId && !allCategories.some(function(c){ return isSameCategory(c.id, activeCategoryId); })){
      activeCategoryId = null;
    }
    renderCategories();
  }

  function renderCategories(){
    var $container = $('#mealCategories').empty();
    var hasTable = !!(currentTable || initialTable);
    if(!hasTable){
      $container.append($('<div class="meal-categories-empty"/>').text('請先選擇桌號以顯示分類。'));
      return;
    }

    if(!allCategories.length){
      $container.append($('<div class="meal-categories-empty"/>').text('此餐廳尚無設定分類。'));
      return;
    }

    var $list = $('<div class="meal-categories-list"/>');
    var items = [{ id: null, name: '全部' }].concat(allCategories);
    items.forEach(function(cat){
      var isActive = (!cat.id && !activeCategoryId) || (cat.id && isSameCategory(cat.id, activeCategoryId));
      var $btn = $('<button type="button" class="meal-category-btn"/>')
        .toggleClass('active', !!isActive)
        .text(cat.name)
        .on('click', function(){
          if(isActive){ return; }
          activeCategoryId = cat.id || null;
          renderCategories();
          renderMeals();
          log(cat.id ? ('已切換分類：'+cat.name) : '顯示全部餐點。');
        });
      $list.append($btn);
    });

    $container.append($list);
  }

  function setMeals(meals){
    allMeals = meals || [];
    renderMeals();
  }

  function clearTableSelection(){
    currentTable = null;
    initialTable = null;
    initialMeals = [];
    initialCategories = [];
    $('#tableSummary').hide().empty();
    clearMealSelection({ skipRender: true });
    setCategories([]);
    setMeals([]);
  }

  function lookupTable(number){
    var trimmed = $.trim(number || '');
    if(!trimmed){
      clearTableSelection();
      setTableStatus('請輸入桌號後按查詢。', '');
      return;
    }

    var num = parseInt(trimmed, 10);
    if(!isFinite(num) || num <= 0){
      clearTableSelection();
      setTableStatus('桌號必須為正整數。', 'error');
      return;
    }

    setTableStatus('查詢中…', '');
    clearTableSelection();

    $.getJSON(lookupUrl, { number: num })
      .done(function(res){
        if(res && res.ok){
          currentTable = res;
          var zoneText = res.zone ? ('（'+res.zone+'）') : '';
          var summary = '餐廳：'+(res.shopName || res.shopId)+'　桌號：'+res.number+zoneText;
          setTableStatus(summary, 'success');
          $('#tableSummary').text(summary).show();
          log('桌號 '+res.number+' 查詢成功，餐廳：'+(res.shopName || res.shopId));
          clearMealSelection({ skipRender: true });
          fetchMealsForShop(res.shopId);
        } else {
          var msg = res && res.error ? res.error : '查無對應桌號。';
          setTableStatus(msg, 'error');
          log('桌號查詢失敗：'+msg);
        }
      })
      .fail(function(xhr){
        var msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '查詢時發生錯誤。';
        setTableStatus(msg, 'error');
        log('桌號查詢失敗：'+msg);
      });
  }

  function renderMeals(){
    var $list = $('#mealList').empty();
    var hasTable = !!(currentTable || initialTable);
    if(!hasTable){
      $list.append($('<div class="meal-empty"/>').text('請先選擇桌號以顯示餐點。'));
      return;
    }

    if(!allMeals.length){
      $list.append($('<div class="meal-empty"/>').text('此餐廳目前沒有可顯示的餐點。'));
      return;
    }

    var mealsToShow = !activeCategoryId ? allMeals : allMeals.filter(function(m){
      return isSameCategory(m.categoryId, activeCategoryId);
    });

    if(!mealsToShow.length){
      $list.append($('<div class="meal-empty"/>').text('此分類目前沒有餐點。'));
      return;
    }

    mealsToShow.forEach(function(m){
      var isSelected = !!(selectedMeal && (
        (selectedMeal.id && m.id && selectedMeal.id === m.id) ||
        (!selectedMeal.id && !m.id && selectedMeal.name === m.name && selectedMeal.money === m.money)
      ));
      var $card = $('<div class="meal-card"/>').toggleClass('selected', !!isSelected);
      $card.append($('<div class="meal-name"/>').text(m.name));
      if(m.categoryName){
        $card.append($('<div class="meal-category-label"/>').text(m.categoryName));
      }
      $card.append($('<div class="meal-price"/>').text('NT$ '+ m.money));
      if(m.element){
        $card.append($('<div class="meal-element"/>').text(m.element));
      }
      var $btn = $('<button type="button"/>')
        .text(isSelected ? '已選擇' : '選擇餐點')
        .prop('disabled', !!isSelected)
        .on('click', function(){
          applyMealSelection(m);
        });
      $card.append($btn);
      $list.append($card);
    });
  }

  function applyMealSelection(meal){
    selectedMeal = meal;
    $('#selectedMealText').text('已選擇餐點：'+meal.name+'（NT$ '+meal.money+'）');
    $('#clearMeal').show();
    setTableStatus('已選擇餐點：'+meal.name, 'success');
    log('已選擇餐點：'+meal.name+'（價格：'+meal.money+'）');
    renderMeals();
  }

  function clearMealSelection(options){
    selectedMeal = null;
    $('#selectedMealText').text('尚未選擇餐點。');
    $('#clearMeal').hide();
    if(!(options && options.skipRender)){
      renderMeals();
    }
  }

  function fetchMealsForShop(shopId){
    if(!shopId){
      setCategories([]);
      setMeals([]);
      clearMealSelection({ skipRender: true });
      return;
    }

    $.getJSON(mealLookupUrl, { shopId: shopId })
      .done(function(res){
        if(res && res.ok){
          initialCategories = res.categories || [];
          initialMeals = res.items || [];
          clearMealSelection({ skipRender: true });
          setCategories(initialCategories);
          setMeals(initialMeals);
          log('已載入餐點 '+((res.items && res.items.length) || 0)+' 項，分類 '+((res.categories && res.categories.length) || 0)+' 個。');
        } else {
          var msg = res && res.error ? res.error : '載入餐點失敗。';
          initialCategories = [];
          initialMeals = [];
          setCategories([]);
          setMeals([]);
          clearMealSelection({ skipRender: true });
          log(msg);
        }
      })
      .fail(function(xhr){
        var msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '載入餐點時發生錯誤。';
        initialCategories = [];
        initialMeals = [];
        setCategories([]);
        setMeals([]);
        clearMealSelection({ skipRender: true });
        log(msg);
      });
  }

  $('#lookupTable').on('click', function(){ lookupTable($('#tableNumber').val()); });
  $('#tableNumber').on('keyup', function(evt){ if(evt.key === 'Enter'){ lookupTable(this.value); } });
  $('#tableNumber').on('blur', function(){ if(this.value){ lookupTable(this.value); } });
  $('#clearMeal').on('click', function(){
    clearMealSelection();
    setTableStatus('已清除餐點選擇。', '');
    log('已清除餐點選擇。');
  });

  function tryFillFromQuery(){
    if(initialTable){ return; }
    var params = new URLSearchParams(window.location.search);
    var val = params.get('table') || params.get('tableNumber');
    if(val){
      $('#tableNumber').val(val);
      lookupTable(val);
    }
  }

  hub.client.orderChanged = function(p){ log('[orderChanged] '+JSON.stringify(p)); };

  function applyInitialTable(){
    if(initialTable){
      currentTable = initialTable;
      $('#tableNumber').val(initialTable.number);
      var zoneText = initialTable.zone ? ('（'+initialTable.zone+'）') : '';
      var summary = '餐廳：'+(initialTable.shopName || initialTable.shopId)+'　桌號：'+initialTable.number+zoneText;
      setTableStatus(summary, 'success');
      $('#tableSummary').text(summary).show();
      clearMealSelection({ skipRender: true });
      log('已載入桌號 '+initialTable.number+' 的資料。');
    } else if(initialError){
      setTableStatus(initialError, 'error');
      log(initialError);
    }
  }

  applyInitialTable();
  setCategories(initialCategories);
  setMeals(initialMeals);

  $.connection.hub.start().done(function(){
    $('#log').append('已連線\n');
    if(initialTable && initialTable.shopId){
      fetchMealsForShop(initialTable.shopId);
    } else {
      tryFillFromQuery();
    }
    $('#send').click(function(){
      if(!currentTable || !currentTable.shopId){
        var msg = '請先查詢有效的桌號後再下單。';
        setTableStatus(msg, 'error');
        log(msg);
        return;
      }

      if(!selectedMeal){
        var mealMsg = '請先從餐點列表選擇餐點。';
        setTableStatus(mealMsg, 'error');
        log(mealMsg);
        return;
      }

      var dto = {
        shopId: currentTable.shopId,
        shopName: currentTable.shopName,
        tableId: currentTable.tableId,
        tableNumber: currentTable.number,
        tableZone: currentTable.zone,
        notes: null,
        items: [{ name: selectedMeal.name, qty: 1, price: selectedMeal.money }]
      };

      hub.server.createOrder(dto);
      setTableStatus('已送出訂單，餐點：'+selectedMeal.name, 'success');
      log('已送出：'+JSON.stringify(dto));
    });
  }).fail(function(){
    setTableStatus('SignalR 連線失敗，請重新整理頁面。', 'error');
  });
    </script>
</body>
</html>
