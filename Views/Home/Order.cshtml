@model BreakFastShop.Models.OrderPageViewModel
@using System.Linq
@using System.Web.Helpers
@{
    Layout = null;
    var tablePayload = Model?.Table == null ? null : new
    {
        tableId = Model.Table.Id,
        number = Model.Table.Number,
        shopId = Model.Table.ShopId,
        shopName = Model.Table.ShopName,
        zone = Model.Table.Zone
    };
    var mealsPayload = Model?.Meals?
        .Select(m => (object)new { id = m.Id, name = m.Name, money = m.Money, element = m.Element, categoryId = m.CategoryId, categoryName = m.CategoryName })
        .ToList() ?? new List<object>();
    var categoriesPayload = Model?.Categories?
        .Select(c => (object)new { id = c.Id, name = c.Name })
        .ToList() ?? new List<object>();
    var errorMessage = Model?.Error;
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>下單頁</title>
    <script src="~/Scripts/jquery-3.7.0.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <style>
        body {
            font-family: system-ui, "Noto Sans TC", sans-serif;
            margin: 2rem;
            background: #f8f9fa;
        }

        h1 {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin: .5rem 0 .25rem;
            font-weight: 600;
        }

        input,
        textarea {
            width: 100%;
            padding: .5rem;
            border: 1px solid #ced4da;
            border-radius: .375rem;
            font-size: 1rem;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
        }

        button {
            border: none;
            border-radius: .375rem;
            cursor: pointer;
        }

        .table-input {
            display: flex;
            gap: .5rem;
            align-items: center;
            margin-bottom: .25rem;
        }

        .table-input input {
            flex: 1;
        }

        .table-input button {
            padding: .5rem 1rem;
            background: #0d6efd;
            color: #fff;
        }

        .table-status {
            margin-bottom: .75rem;
            font-size: .95rem;
            color: #555;
            min-height: 1.5rem;
        }

        .table-status.error {
            color: #b21f1f;
        }

        .table-status.success {
            color: #0f5132;
        }

        #send {
            padding: .75rem 1.5rem;
            background: #198754;
            color: #fff;
            font-size: 1rem;
            width: 100%;
        }

        .cart-container {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: .5rem;
            padding: 1rem 1.25rem;
            margin-top: 1.5rem;
            box-shadow: inset 0 0 0 rgba(0, 0, 0, 0);
        }

        .cart-container h2 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .cart-summary {
            font-size: .95rem;
            margin-bottom: .75rem;
            color: #495057;
        }

        .cart-list {
            display: flex;
            flex-direction: column;
            gap: .75rem;
            max-height: 14rem;
            overflow-y: auto;
            padding-right: .25rem;
        }

        .cart-empty {
            padding: 1.25rem;
            border: 1px dashed #ced4da;
            border-radius: .5rem;
            text-align: center;
            color: #6c757d;
            background: #fff;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: .5rem 1rem;
            background: #f8f9fa;
            border-radius: .5rem;
            padding: .75rem 1rem;
            border: 1px solid #e9ecef;
        }

        .cart-item-header {
            display: flex;
            flex-direction: column;
            gap: .25rem;
        }

        .cart-item-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .cart-item-price {
            color: #6c757d;
            font-size: .95rem;
        }

        .cart-item-note {
            font-size: .85rem;
            color: #868e96;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: .5rem;
        }

        .cart-item-qty {
            display: inline-flex;
            align-items: center;
            gap: .25rem;
        }

        .cart-item-qty button,
        .cart-remove {
            padding: .25rem .6rem;
            border-radius: .375rem;
            background: #0d6efd;
            color: #fff;
            font-size: .9rem;
        }

        .cart-item-qty-value {
            min-width: 2rem;
            text-align: center;
            font-weight: 600;
        }

        .cart-remove {
            background: #dc3545;
        }

        .cart-footer {
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: .75rem;
            flex-wrap: wrap;
        }

        .cart-total {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .cart-clear {
            padding: .35rem .75rem;
            background: #6c757d;
            color: #fff;
            border-radius: .375rem;
            font-size: .9rem;
        }

        #send:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .order-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .order-panel {
            flex: 1 1 320px;
            max-width: 420px;
            background: #fff;
            padding: 1.5rem;
            border-radius: .5rem;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .order-fields {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .table-summary {
            padding: .75rem 1rem;
            border-radius: .5rem;
            background: #f8f9fa;
            color: #495057;
            line-height: 1.5;
        }

        .order-submit {
            margin-top: auto;
            padding-top: 1.5rem;
        }

        .meal-panel {
            flex: 1 1 320px;
            min-width: 280px;
        }

        .meal-panel h2 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .meal-categories {
            margin-bottom: 1rem;
        }

        .meal-categories-list {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
        }

        .meal-categories-empty {
            color: #6c757d;
            font-style: italic;
            background: #fff;
            border: 1px dashed #ced4da;
            padding: .75rem 1rem;
            border-radius: .5rem;
            text-align: center;
        }

        .meal-category-btn {
            padding: .5rem 1rem;
            background: #e9ecef;
            color: #212529;
            border: 1px solid transparent;
            border-radius: 999px;
            font-size: .95rem;
            transition: all .2s ease;
        }

        .meal-category-btn:hover,
        .meal-category-btn:focus {
            background: #d1e7ff;
            color: #0d6efd;
        }

        .meal-category-btn.active {
            background: #0d6efd;
            color: #fff;
            border-color: #0a58ca;
            box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.2);
        }

        .meal-list {
            display: flex;
            flex-direction: column;
            gap: .75rem;
        }

        .meal-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: .5rem;
            padding: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
        }

        .meal-card.selected {
            border-color: #0d6efd;
            box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.2);
        }

        .meal-card.selected .meal-name {
            color: #0d6efd;
        }

        .meal-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .meal-price {
            margin-top: .25rem;
            color: #0f5132;
            font-weight: 600;
        }

        .meal-element {
            margin-top: .35rem;
            color: #6c757d;
            font-size: .9rem;
            white-space: pre-wrap;
        }

        .meal-category-label {
            display: inline-block;
            margin-top: .35rem;
            padding: .25rem .5rem;
            background: #e7f1ff;
            color: #0d6efd;
            border-radius: .375rem;
            font-size: .85rem;
        }

        .meal-card button {
            margin-top: .75rem;
            padding: .55rem 1.25rem;
            background: #0d6efd;
            color: #fff;
            font-size: .95rem;
            font-weight: 600;
            border-radius: .5rem;
            transition: background .2s ease;
        }

        .meal-card button:hover {
            background: #0b5ed7;
        }

        .meal-card button:disabled {
            background: #6c757d;
            cursor: default;
        }

        .meal-cart-indicator {
            margin-top: .5rem;
            font-size: .9rem;
            color: #0f5132;
        }

        .meal-empty {
            color: #6c757d;
            font-style: italic;
            background: #fff;
            border: 1px dashed #ced4da;
            padding: 1rem;
            border-radius: .5rem;
            text-align: center;
        }

        @@media (max-width: 768px) {
            body {
                margin: 1.25rem;
            }

            .order-panel {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>下單頁</h1>
    <div class="order-layout">
        <section class="order-panel">
            <div class="order-fields">
                <div>
                    <label>桌號</label>
                    <div class="table-input">
                        <input id="tableNumber" type="number" min="1" placeholder="請輸入桌號">
                        <button id="lookupTable" type="button">查詢桌號</button>
                    </div>
                </div>
                <div class="table-status" id="tableStatus">請輸入桌號後按查詢。</div>
                <div class="table-summary" id="tableSummary" style="display:none;"></div>
                <div class="cart-container">
                    <h2>購物車</h2>
                    <div class="cart-summary" id="cartSummary">購物車目前沒有餐點。</div>
                    <div class="cart-list" id="cartList"></div>
                    <div class="cart-footer">
                        <div class="cart-total" id="cartTotal">總計：NT$ 0</div>
                        <button id="clearCart" type="button" class="cart-clear" style="display:none;">清空購物車</button>
                    </div>
                </div>
            </div>
            <div class="order-submit">
                <button id="send">送出訂單</button>
            </div>
        </section>
        <aside class="meal-panel">
            <h2>餐點列表</h2>
            <div class="meal-categories" id="mealCategories"></div>
            <div class="meal-list" id="mealList"></div>
        </aside>
    </div>
    <script>
  (function(){
    var hub = $.connection.ordersHub;
    var lookupUrl = '@Url.Action("TableInfo","Home")';
    var mealLookupUrl = '@Url.Action("ShopMeals","Home")';
    var currentTable = null;
    var initialTable = @Html.Raw(Json.Encode(tablePayload));
    var initialMeals = @Html.Raw(Json.Encode(mealsPayload));
    var initialCategories = @Html.Raw(Json.Encode(categoriesPayload));
    var initialError = @Html.Raw(Json.Encode(errorMessage));
    var allMeals = [];
    var allCategories = [];
    var activeCategoryId = null;
    var cartItems = [];

    var $cartSummary = $('#cartSummary');
    var $cartList = $('#cartList');
    var $cartTotal = $('#cartTotal');
    var $clearCart = $('#clearCart');
    var $sendButton = $('#send');

    function formatCurrency(value){
      return 'NT$ ' + (Number(value) || 0).toLocaleString('zh-TW');
    }

    function setTableStatus(message, type){
      var $status = $('#tableStatus');
      $status.removeClass('error success');
      if(type === 'error'){ $status.addClass('error'); }
      if(type === 'success'){ $status.addClass('success'); }
      $status.text(message);
    }

    function updateSendButtonState(){
      var canSend = !!(currentTable && currentTable.shopId && cartItems.length);
      $sendButton.prop('disabled', !canSend);
    }

    function cartKeyMatches(item, meal){
      if(item.id && meal.id){
        return item.id === meal.id;
      }
      return !item.id && !meal.id && item.name === meal.name && item.price === Number(meal.money || 0);
    }

    function getCartQtyForMeal(meal){
      var foundQty = 0;
      cartItems.some(function(item){
        if(cartKeyMatches(item, meal)){
          foundQty = item.qty;
          return true;
        }
        return false;
      });
      return foundQty;
    }

    function renderCart(){
      $cartList.empty();
      if(!cartItems.length){
        $cartSummary.text('購物車目前沒有餐點。');
        $cartList.append($('<div class="cart-empty"/>').text('尚未加入餐點。'));
        $cartTotal.text('總計：NT$ 0');
        $clearCart.hide();
        updateSendButtonState();
        return;
      }

      var totalQty = 0;
      var totalAmount = 0;

      cartItems.forEach(function(item, index){
        totalQty += item.qty;
        totalAmount += item.price * item.qty;

        var $item = $('<div class="cart-item"/>');
        var $header = $('<div class="cart-item-header"/>');
        $header.append($('<div class="cart-item-name"/>').text(item.name));
        $header.append($('<div class="cart-item-price"/>').text(formatCurrency(item.price) + ' × ' + item.qty));
        if(item.categoryName){
          $header.append($('<div class="cart-item-note"/>').text(item.categoryName));
        }
        if(item.element){
          $header.append($('<div class="cart-item-note"/>').text(item.element));
        }
        $item.append($header);

        var $actions = $('<div class="cart-item-actions"/>');
        var $qty = $('<div class="cart-item-qty"/>');
        $('<button type="button">-</button>')
          .on('click', function(){ changeCartItemQuantity(index, -1); })
          .appendTo($qty);
        $('<div class="cart-item-qty-value"/>').text(item.qty).appendTo($qty);
        $('<button type="button">+</button>')
          .on('click', function(){ changeCartItemQuantity(index, 1); })
          .appendTo($qty);
        $actions.append($qty);

        $('<button type="button" class="cart-remove"/>')
          .text('移除')
          .on('click', function(){ removeCartItem(index); })
          .appendTo($actions);

        $item.append($actions);
        $cartList.append($item);
      });

      $cartSummary.text('購物車共有 ' + totalQty + ' 份餐點（' + cartItems.length + ' 項）。');
      $cartTotal.text('總計：' + formatCurrency(totalAmount));
      $clearCart.show();
      updateSendButtonState();
    }

    function changeCartItemQuantity(index, delta){
      if(index < 0 || index >= cartItems.length){ return; }
      var item = cartItems[index];
      var nextQty = item.qty + delta;
      if(nextQty <= 0){
        cartItems.splice(index, 1);
      } else {
        item.qty = nextQty;
      }
      renderCart();
      renderMeals();
    }

    function removeCartItem(index){
      if(index < 0 || index >= cartItems.length){ return; }
      cartItems.splice(index, 1);
      renderCart();
      renderMeals();
      setTableStatus('已從購物車移除餐點。', '');
    }

    function clearCart(options){
      var skipStatus = options && options.skipStatus;
      if(!cartItems.length){
        renderCart();
        renderMeals();
        updateSendButtonState();
        return;
      }
      cartItems = [];
      renderCart();
      renderMeals();
      if(!skipStatus){
        setTableStatus('購物車已清空。', '');
      }
    }

    function addMealToCart(meal){
      var price = Number(meal.money || 0);
      var existing = null;
      cartItems.some(function(item){
        if(cartKeyMatches(item, meal)){
          existing = item;
          return true;
        }
        return false;
      });

      if(existing){
        existing.qty += 1;
      } else {
        cartItems.push({
          id: meal.id || null,
          name: meal.name,
          price: price,
          qty: 1,
          categoryName: meal.categoryName || '',
          element: meal.element || ''
        });
      }

      renderCart();
      renderMeals();
      setTableStatus('已加入餐點：' + meal.name, 'success');
    }

    function isSameCategory(a, b){
      return (a || '') === (b || '');
    }

    function setCategories(categories){
      allCategories = categories || [];
      if(activeCategoryId && !allCategories.some(function(c){ return isSameCategory(c.id, activeCategoryId); })){
        activeCategoryId = null;
      }
      renderCategories();
    }

    function renderCategories(){
      var $container = $('#mealCategories').empty();
      var hasTable = !!(currentTable || initialTable);
      if(!hasTable){
        $container.append($('<div class="meal-categories-empty"/>').text('請先選擇桌號以顯示分類。'));
        return;
      }

      if(!allCategories.length){
        $container.append($('<div class="meal-categories-empty"/>').text('此餐廳尚無設定分類。'));
        return;
      }

      var $list = $('<div class="meal-categories-list"/>');
      var items = [{ id: null, name: '全部' }].concat(allCategories);
      items.forEach(function(cat){
        var isActive = (!cat.id && !activeCategoryId) || (cat.id && isSameCategory(cat.id, activeCategoryId));
        var $btn = $('<button type="button" class="meal-category-btn"/>')
          .toggleClass('active', !!isActive)
          .text(cat.name)
          .on('click', function(){
            if(isActive){ return; }
            activeCategoryId = cat.id || null;
            renderCategories();
            renderMeals();
          });
        $list.append($btn);
      });

      $container.append($list);
    }

    function setMeals(meals){
      allMeals = meals || [];
      renderMeals();
    }

    function clearTableSelection(){
      currentTable = null;
      initialTable = null;
      initialMeals = [];
      initialCategories = [];
      $('#tableSummary').hide().empty();
      clearCart({ skipStatus: true });
      setCategories([]);
      setMeals([]);
      updateSendButtonState();
    }

    function lookupTable(number){
      var trimmed = $.trim(number || '');
      if(!trimmed){
        clearTableSelection();
        setTableStatus('請輸入桌號後按查詢。', '');
        return;
      }

      var num = parseInt(trimmed, 10);
      if(!isFinite(num) || num <= 0){
        clearTableSelection();
        setTableStatus('桌號必須為正整數。', 'error');
        return;
      }

      setTableStatus('查詢中…', '');
      clearTableSelection();

      $.getJSON(lookupUrl, { number: num })
        .done(function(res){
          if(res && res.ok){
            currentTable = res;
            var zoneText = res.zone ? ('（' + res.zone + '）') : '';
            var summary = '餐廳：' + (res.shopName || res.shopId) + '　桌號：' + res.number + zoneText;
            setTableStatus(summary, 'success');
            $('#tableSummary').text(summary).show();
            clearCart({ skipStatus: true });
            fetchMealsForShop(res.shopId);
          } else {
            var msg = res && res.error ? res.error : '查無對應桌號。';
            setTableStatus(msg, 'error');
          }
        })
        .fail(function(xhr){
          var msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '查詢時發生錯誤。';
          setTableStatus(msg, 'error');
        });
    }

    function renderMeals(){
      var $list = $('#mealList').empty();
      var hasTable = !!(currentTable || initialTable);
      if(!hasTable){
        $list.append($('<div class="meal-empty"/>').text('請先選擇桌號以顯示餐點。'));
        return;
      }

      if(!allMeals.length){
        $list.append($('<div class="meal-empty"/>').text('此餐廳目前沒有可顯示的餐點。'));
        return;
      }

      var mealsToShow = !activeCategoryId ? allMeals : allMeals.filter(function(m){
        return isSameCategory(m.categoryId, activeCategoryId);
      });

      if(!mealsToShow.length){
        $list.append($('<div class="meal-empty"/>').text('此分類目前沒有餐點。'));
        return;
      }

      mealsToShow.forEach(function(m){
        var $card = $('<div class="meal-card"/>');
        $card.append($('<div class="meal-name"/>').text(m.name));
        if(m.categoryName){
          $card.append($('<div class="meal-category-label"/>').text(m.categoryName));
        }
        $card.append($('<div class="meal-price"/>').text(formatCurrency(m.money)));
        if(m.element){
          $card.append($('<div class="meal-element"/>').text(m.element));
        }
        var $btn = $('<button type="button"/>')
          .text('加入購物車')
          .on('click', function(){
            addMealToCart(m);
          });
        $card.append($btn);

        var qty = getCartQtyForMeal(m);
        if(qty > 0){
          $card.append($('<div class="meal-cart-indicator"/>').text('購物車中已有 ' + qty + ' 份。'));
        }

        $list.append($card);
      });
    }

    function fetchMealsForShop(shopId){
      if(!shopId){
        setCategories([]);
        setMeals([]);
        clearCart({ skipStatus: true });
        return;
      }

      $.getJSON(mealLookupUrl, { shopId: shopId })
        .done(function(res){
          if(res && res.ok){
            initialCategories = res.categories || [];
            initialMeals = res.items || [];
            clearCart({ skipStatus: true });
            setCategories(initialCategories);
            setMeals(initialMeals);
          } else {
            var msg = res && res.error ? res.error : '載入餐點失敗。';
            initialCategories = [];
            initialMeals = [];
            setCategories([]);
            setMeals([]);
            clearCart({ skipStatus: true });
            setTableStatus(msg, 'error');
          }
        })
        .fail(function(xhr){
          var msg = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '載入餐點時發生錯誤。';
          initialCategories = [];
          initialMeals = [];
          setCategories([]);
          setMeals([]);
          clearCart({ skipStatus: true });
          setTableStatus(msg, 'error');
        });
    }

    $('#lookupTable').on('click', function(){ lookupTable($('#tableNumber').val()); });
    $('#tableNumber').on('keyup', function(evt){ if(evt.key === 'Enter'){ lookupTable(this.value); } });
    $('#tableNumber').on('blur', function(){ if(this.value){ lookupTable(this.value); } });

    $clearCart.on('click', function(){
      clearCart({ skipStatus: false });
    });

    function tryFillFromQuery(){
      if(initialTable){ return; }
      var params = new URLSearchParams(window.location.search);
      var val = params.get('table') || params.get('tableNumber');
      if(val){
        $('#tableNumber').val(val);
        lookupTable(val);
      }
    }

    hub.client.orderChanged = function(payload){
      console.log('orderChanged', payload);
    };

    function applyInitialTable(){
      if(initialTable){
        currentTable = initialTable;
        $('#tableNumber').val(initialTable.number);
        var zoneText = initialTable.zone ? ('（' + initialTable.zone + '）') : '';
        var summary = '餐廳：' + (initialTable.shopName || initialTable.shopId) + '　桌號：' + initialTable.number + zoneText;
        setTableStatus(summary, 'success');
        $('#tableSummary').text(summary).show();
      } else if(initialError){
        setTableStatus(initialError, 'error');
      }
    }

    applyInitialTable();
    setCategories(initialCategories);
    setMeals(initialMeals);
    renderCart();
    updateSendButtonState();

    $.connection.hub.start().done(function(){
      if(initialTable && initialTable.shopId){
        fetchMealsForShop(initialTable.shopId);
      } else {
        tryFillFromQuery();
      }
      $sendButton.on('click', function(){
        if(!currentTable || !currentTable.shopId){
          var msg = '請先查詢有效的桌號後再下單。';
          setTableStatus(msg, 'error');
          return;
        }

        if(!cartItems.length){
          var emptyMsg = '請先將餐點加入購物車。';
          setTableStatus(emptyMsg, 'error');
          return;
        }

        var dto = {
          shopId: currentTable.shopId,
          shopName: currentTable.shopName,
          tableId: currentTable.tableId,
          tableNumber: currentTable.number,
          tableZone: currentTable.zone,
          notes: null,
          items: cartItems.map(function(item){
            return { name: item.name, qty: item.qty, price: item.price };
          })
        };

        hub.server.createOrder(dto);
        var totalQty = cartItems.reduce(function(sum, item){ return sum + item.qty; }, 0);
        setTableStatus('已送出訂單，共 ' + totalQty + ' 份餐點。', 'success');
        clearCart({ skipStatus: true });
        updateSendButtonState();
      });
    }).fail(function(){
      setTableStatus('SignalR 連線失敗，請重新整理頁面。', 'error');
    });
  })();
    </script>
</body>
</html>
