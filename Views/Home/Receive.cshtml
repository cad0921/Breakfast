@model BreakFastShop.Models.ReceivePageViewModel
@using System.Web
@{
    Layout = null;
    var initialShopId = Model?.InitialShopId?.Trim();
    var hasInitialShopId = !string.IsNullOrWhiteSpace(initialShopId);
    var initialStatusText = hasInitialShopId
        ? "正在讀取店家資訊，請稍候。"
        : string.Empty;
    var bodyStateClass = hasInitialShopId ? "state-active" : "state-blank";
    var statusClass = "status info" + (string.IsNullOrWhiteSpace(initialStatusText) ? " is-hidden" : string.Empty);
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>接收頁</title>
    <script src="~/Scripts/jquery-3.7.0.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <style>
        :root {
            color-scheme: light;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #edf2ff, #f8f9fa 42%, #fff);
            font-family: "Noto Sans TC", "Segoe UI", system-ui, -apple-system, sans-serif;
            color: #1f2937;
            transition: background 0.4s ease;
        }

        .page-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: clamp(1.75rem, 4vw, 3.5rem);
            gap: clamp(1.5rem, 3vw, 2.5rem);
        }

        body.state-blank {
            background: #ffffff;
        }

            body.state-blank .page {
                display: none;
            }

        .page-header {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            justify-content: space-between;
            gap: clamp(1.25rem, 3vw, 2rem);
        }

        .page-header-left {
            display: flex;
            flex-direction: column;
            gap: .5rem;
            align-items: flex-start;
        }

        .page-header-hint {
            font-size: .85rem;
            letter-spacing: .05em;
            text-transform: uppercase;
            font-weight: 600;
            color: rgba(15, 23, 42, 0.55);
        }

        .page {
            flex: 1;
            width: 100%;
            display: flex;
            min-height: 0;
        }

        .panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 1.75rem;
            padding: clamp(2.1rem, 3.5vw, 3.2rem);
            box-shadow: 0 40px 90px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.18);
            backdrop-filter: blur(6px);
            display: flex;
            flex-direction: column;
            gap: clamp(1.5rem, 3vw, 2.5rem);
            min-height: 0;
        }

        .panel--frameless {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
        }

        .panel-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: clamp(1.4rem, 2.6vw, 2.2rem);
            min-height: 0;
        }

        .panel-orders {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: clamp(1.1rem, 2vw, 1.6rem);
            background: rgba(248, 250, 252, 0.75);
            border-radius: 1.5rem;
            padding: clamp(1.2rem, 2.2vw, 1.9rem);
            border: 1px solid rgba(148, 163, 184, 0.28);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.35);
            min-height: 0;
        }

        .shop-card {
            position: relative;
            padding: 1.1rem 1.35rem;
            border-radius: 1.25rem;
            background: rgba(59, 130, 246, 0.12);
            border: 1px solid rgba(59, 130, 246, 0.3);
            display: flex;
            flex-direction: column;
            gap: .45rem;
            transition: background .3s ease, border-color .3s ease, box-shadow .3s ease;
        }

            .shop-card.is-empty {
                background: rgba(148, 163, 184, 0.12);
                border-color: rgba(148, 163, 184, 0.4);
            }

            .shop-card.is-loading {
                background: rgba(59, 130, 246, 0.18);
                border-color: rgba(37, 99, 235, 0.4);
                box-shadow: 0 15px 30px rgba(37, 99, 235, 0.18);
            }

            .shop-card.is-error {
                background: rgba(248, 113, 113, 0.14);
                border-color: rgba(239, 68, 68, 0.4);
                box-shadow: 0 15px 30px rgba(239, 68, 68, 0.18);
            }

        .shop-selector {
            display: flex;
            flex-direction: column;
            gap: .65rem;
            margin-top: 1.25rem;
            width: min(320px, 100%);
        }

            .shop-selector label {
                font-size: .9rem;
                font-weight: 600;
                color: rgba(15, 23, 42, 0.65);
            }

            .shop-selector-controls {
                display: flex;
                gap: .55rem;
            }

            .shop-selector input {
                flex: 1;
                padding: .6rem .75rem;
                border: 1px solid rgba(148, 163, 184, 0.4);
                border-radius: 12px;
                font-size: 1rem;
                color: var(--text);
                background: #fff;
            }

            .shop-selector input:focus {
                outline: none;
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            }

            .shop-selector button {
                border: none;
                border-radius: 12px;
                padding: .6rem 1.1rem;
                background: #2563eb;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: transform .15s ease, box-shadow .15s ease;
            }

            .shop-selector button:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 20px rgba(37, 99, 235, 0.22);
            }

        .shop-card-label {
            font-size: .82rem;
            letter-spacing: .05em;
            text-transform: uppercase;
            font-weight: 600;
            color: rgba(15, 23, 42, 0.55);
        }

        .shop-card-value {
            font-size: clamp(1.35rem, 4vw, 2.1rem);
            font-weight: 700;
            color: #0f172a;
        }

        .shop-card.is-empty .shop-card-value {
            color: #64748b;
        }

        .shop-card-id {
            font-family: "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: .85rem;
            color: rgba(15, 23, 42, 0.58);
            overflow-wrap: anywhere;
            letter-spacing: .04em;
        }

        .status {
            padding: 1rem 1.15rem;
            border-radius: 1rem;
            font-size: .95rem;
            display: flex;
            align-items: center;
            gap: .6rem;
            background: rgba(59, 130, 246, 0.08);
            color: #1d4ed8;
            border: 1px solid transparent;
            transition: background .3s ease, color .3s ease, border-color .3s ease;
        }

            .status::before {
                content: '';
                display: inline-block;
                width: .65rem;
                height: .65rem;
                border-radius: 50%;
                background: currentColor;
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.18);
            }

            .status.success {
                background: rgba(16, 185, 129, 0.12);
                color: #047857;
                border-color: rgba(16, 185, 129, 0.25);
            }

                .status.success::before {
                    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.24);
                }

            .status.error {
                background: rgba(248, 113, 113, 0.14);
                color: #b91c1c;
                border-color: rgba(248, 113, 113, 0.35);
            }

                .status.error::before {
                    box-shadow: 0 0 0 4px rgba(248, 113, 113, 0.24);
                }

            .status.is-hidden {
                display: none;
            }

        .page-header .status {
            align-self: flex-start;
            min-width: min(320px, 100%);
        }

        body.state-blank .page-header .status {
            display: none;
        }

        .orders {
            flex: 1;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(248, 250, 252, 0.65);
            padding: 1.1rem 1.25rem;
            overflow-y: auto;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
            min-height: 0;
        }

        .orders-filters {
            display: flex;
            gap: .65rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .orders-filter-btn {
            border: 1px solid rgba(59, 130, 246, 0.35);
            background: rgba(59, 130, 246, 0.08);
            color: #1d4ed8;
            padding: .45rem .9rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: .9rem;
            transition: background .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease;
        }

            .orders-filter-btn:hover,
            .orders-filter-btn:focus {
                background: rgba(59, 130, 246, 0.16);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
                outline: none;
            }

            .orders-filter-btn.is-active {
                background: #2563eb;
                border-color: #2563eb;
                color: #ffffff;
                box-shadow: 0 10px 18px -12px rgba(37, 99, 235, 0.8);
            }

        .orders-entry-hidden {
            display: none !important;
        }

        .orders-empty {
            text-align: center;
            color: #94a3b8;
            font-size: .95rem;
            padding: 1.75rem 0;
        }

            .orders-empty.orders-empty-filter {
                padding: 1.25rem 0;
                color: #64748b;
                font-size: .9rem;
            }

        .orders-entry {
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
            padding: .85rem 0;
        }

            .orders-entry:last-child {
                border-bottom: none;
            }

            .orders-entry.order-entry-disabled {
                opacity: .9;
            }

        .orders-entry-time {
            font-size: .8rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: .08em;
        }

        .orders-entry-title {
            margin-top: .3rem;
            font-weight: 600;
            font-size: 1.05rem;
            color: #0f172a;
        }

        .orders-entry-status {
            color: #2563eb;
        }

        .orders-entry-statusline {
            margin-top: .6rem;
            display: flex;
            align-items: center;
            gap: .5rem;
            font-size: .9rem;
            color: #475569;
            flex-wrap: wrap;
        }

        .orders-entry-status-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: .2rem .65rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: .82rem;
            letter-spacing: .03em;
            text-transform: none;
        }

            .orders-entry-status-chip.is-pending {
                background: rgba(59, 130, 246, 0.18);
                color: #1d4ed8;
            }

            .orders-entry-status-chip.is-preparing {
                background: rgba(96, 165, 250, 0.18);
                color: #1d4ed8;
            }

            .orders-entry-status-chip.is-completed {
                background: rgba(16, 185, 129, 0.18);
                color: #047857;
            }

            .orders-entry-status-chip.is-cancelled {
                background: rgba(248, 113, 113, 0.18);
                color: #b91c1c;
            }

        .orders-entry-items {
            margin: .55rem 0 0;
            padding-left: 1.4rem;
            color: #475569;
        }

            .orders-entry-items li {
                margin: .25rem 0;
            }

        .orders-entry-item-main {
            display: block;
        }

        .orders-entry-item-note {
            margin-top: .2rem;
            font-size: .85rem;
            color: #64748b;
            white-space: pre-wrap;
        }

        .orders-entry-meta,
        .orders-entry-note {
            margin-top: .35rem;
            font-size: .92rem;
            color: #475569;
        }

        .orders-entry-total {
            font-weight: 600;
        }

        .orders-entry-body {
            margin-top: .5rem;
            background: rgba(226, 232, 240, 0.55);
            border-radius: .65rem;
            padding: .75rem;
            font-size: .9rem;
            white-space: pre-wrap;
            color: #1f2937;
        }

        .orders-entry-actions {
            margin-top: .75rem;
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
        }

        .order-action-btn {
            border: none;
            border-radius: 999px;
            padding: .4rem 1.05rem;
            font-weight: 600;
            font-size: .9rem;
            letter-spacing: .02em;
            cursor: pointer;
            transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
        }

            .order-action-btn.complete {
                background: linear-gradient(135deg, #38bdf8, #0ea5e9);
                color: #fff;
                box-shadow: 0 8px 18px rgba(14, 165, 233, 0.25);
            }

            .order-action-btn.cancel {
                background: linear-gradient(135deg, #fb7185, #f97316);
                color: #fff;
                box-shadow: 0 8px 18px rgba(251, 113, 133, 0.25);
            }

            .order-action-btn:hover:not(:disabled) {
                transform: translateY(-1px);
                box-shadow: 0 10px 22px rgba(15, 23, 42, 0.15);
            }

            .order-action-btn:disabled {
                opacity: .55;
                cursor: not-allowed;
                box-shadow: none;
                transform: none;
            }

        @@media (min-width: 960px) {
            .page-shell {
                padding: clamp(2.5rem, 5vw, 4rem);
            }

            .panel {
                padding: clamp(2.4rem, 3.2vw, 3.4rem);
            }

            .panel-orders {
                padding: clamp(1.4rem, 2.4vw, 2.1rem);
            }
        }

        @@media (max-width: 640px) {
            .page-shell {
                padding: 1.5rem;
            }

            .panel {
                padding: 1.75rem;
                border-radius: 1.5rem;
            }

            .panel-orders {
                padding: 1rem 1.1rem;
            }

            .orders {
                padding: .9rem 1rem;
            }
        }

        .mode-switch {
            display: inline-flex;
            padding: .35rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.06);
            gap: .35rem;
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

            .mode-switch button {
                border: none;
                background: transparent;
                padding: .55rem 1.15rem;
                border-radius: 999px;
                font-weight: 700;
                letter-spacing: .02em;
                color: #475569;
                cursor: pointer;
                transition: all .18s ease;
            }

            .mode-switch button.is-active {
                background: linear-gradient(135deg, #2563eb, #4f46e5);
                color: #fff;
                box-shadow: 0 10px 26px rgba(37, 99, 235, 0.25);
            }

        .order-panel {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .order-status {
            border-radius: 12px;
            padding: .75rem 1rem;
            background: rgba(59, 130, 246, 0.08);
            color: #1d4ed8;
            font-weight: 600;
            border: 1px solid rgba(59, 130, 246, 0.22);
        }

            .order-status.is-error {
                background: rgba(248, 113, 113, 0.12);
                color: #b91c1c;
                border-color: rgba(248, 113, 113, 0.32);
            }

            .order-status.is-success {
                background: rgba(34, 197, 94, 0.12);
                color: #15803d;
                border-color: rgba(34, 197, 94, 0.32);
            }

        .order-grid {
            display: grid;
            grid-template-columns: 1.3fr .85fr;
            gap: 1.1rem;
        }

        .order-form-section {
            background: rgba(248, 250, 252, 0.9);
            border-radius: 1.35rem;
            padding: 1.1rem 1.25rem;
            border: 1px solid rgba(148, 163, 184, 0.28);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.45);
        }

        .order-form-section h3 {
            margin: 0 0 .6rem;
            font-size: 1.05rem;
            letter-spacing: .01em;
            color: #0f172a;
        }

        .order-type-toggle {
            display: inline-flex;
            gap: .65rem;
            padding: .35rem;
            border-radius: 999px;
            background: #e2e8f0;
        }

            .order-type-toggle button {
                border: none;
                background: transparent;
                padding: .45rem 1.1rem;
                border-radius: 999px;
                font-weight: 700;
                cursor: pointer;
                color: #475569;
            }

            .order-type-toggle button.is-active {
                background: #fff;
                color: #1e293b;
                box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
            }

        .order-field {
            display: flex;
            flex-direction: column;
            gap: .3rem;
            margin-top: .75rem;
        }

        .order-field label {
            font-size: .95rem;
            font-weight: 700;
            color: #1f2937;
        }

        .order-field input,
        .order-field select,
        .order-field textarea {
            padding: .65rem .75rem;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            font-size: 1rem;
        }

        .order-field textarea {
            resize: vertical;
            min-height: 90px;
        }

        .order-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: .85rem;
        }

        .order-menu-section {
            display: flex;
            flex-direction: column;
            gap: .45rem;
        }

            .order-menu-section h4 {
                margin: 0;
                color: #0f172a;
            }

        .meal-card {
            background: #fff;
            border-radius: 1rem;
            padding: .85rem .95rem;
            border: 1px solid rgba(226, 232, 240, 0.9);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: .35rem;
        }

            .meal-card h4 {
                margin: 0;
                font-size: 1.05rem;
            }

            .meal-card .meal-meta {
                font-size: .9rem;
                color: #475569;
            }

            .meal-card button {
                align-self: flex-start;
                border: none;
                border-radius: 10px;
                background: linear-gradient(135deg, #22c55e, #16a34a);
                color: #fff;
                padding: .45rem .85rem;
                font-weight: 700;
                cursor: pointer;
            }

        .order-cart {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            color: #0f172a;
            border-radius: 1.35rem;
            padding: 1.1rem 1.25rem;
            display: flex;
            flex-direction: column;
            gap: .85rem;
            box-shadow: 0 16px 30px rgba(148, 163, 184, 0.25);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .order-cart h3 {
            margin: 0;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: .35rem;
            padding: .65rem .7rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(226, 232, 240, 0.9);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.06);
        }

            .cart-item strong {
                color: #0f172a;
            }

            .cart-item .cart-item-note {
                color: #475569;
                font-size: .9rem;
            }

        .cart-item-controls {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
        }

            .cart-item-controls button {
                width: 34px;
                height: 34px;
                border-radius: 10px;
                border: 1px solid rgba(148, 163, 184, 0.5);
                background: #fff;
                color: #0f172a;
                cursor: pointer;
                font-weight: 800;
                box-shadow: 0 6px 12px rgba(15, 23, 42, 0.08);
                transition: transform .15s ease, box-shadow .15s ease;
            }

            .cart-item-controls button:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 16px rgba(15, 23, 42, 0.14);
            }

        .cart-empty {
            color: #64748b;
        }

        .order-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: .65rem;
            flex-wrap: wrap;
        }

        .order-submit {
            border: none;
            background: linear-gradient(135deg, #a855f7, #6366f1);
            color: #fff;
            border-radius: 12px;
            padding: .75rem 1.2rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 16px 30px rgba(99, 102, 241, 0.3);
        }

            .order-submit:disabled {
                opacity: .65;
                cursor: not-allowed;
                box-shadow: none;
            }

        .order-total {
            font-size: 1.1rem;
            font-weight: 800;
        }

        .order-options-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.35);
            backdrop-filter: blur(2px);
            padding: 1rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s ease;
            z-index: 40;
        }

            .order-options-modal.is-active {
                opacity: 1;
                pointer-events: auto;
            }

        .order-options-modal__content {
            width: min(640px, 100%);
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 30px 70px rgba(15, 23, 42, 0.18);
            padding: 1.4rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            outline: none;
        }

        .order-options-modal__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .order-options-modal__title {
            margin: 0;
        }

        .order-options-modal__close {
            border: none;
            background: #e2e8f0;
            color: #0f172a;
            width: 38px;
            height: 38px;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .order-options-modal__body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .order-options-modal__meal {
            font-weight: 800;
            font-size: 1.2rem;
        }

        .order-options-error {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecdd3;
            padding: .65rem .8rem;
            border-radius: 10px;
        }

            .order-options-error.is-hidden {
                display: none;
            }

        .meal-option-groups {
            display: flex;
            flex-direction: column;
            gap: .9rem;
        }

        .meal-option-group {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: .85rem .9rem;
            background: #f8fafc;
        }

        .meal-option-group__header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: .75rem;
            margin-bottom: .6rem;
        }

        .meal-option-group__name {
            font-weight: 700;
        }

        .meal-option-group__meta {
            color: #475569;
            font-size: .9rem;
        }

        .meal-option-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: .6rem;
        }

        .meal-option-item {
            display: flex;
            align-items: center;
            gap: .45rem;
            padding: .6rem .65rem;
            border-radius: 10px;
            background: #fff;
            border: 1px solid #e2e8f0;
        }

            .meal-option-item input {
                width: 18px;
                height: 18px;
            }

        .meal-option-item__name {
            font-weight: 700;
        }

        .meal-option-item__price {
            color: #475569;
            font-size: .9rem;
        }

        .order-options-summary {
            background: #f8fafc;
            border-radius: 12px;
            padding: .9rem 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: .5rem;
            border: 1px solid #e2e8f0;
        }

        .order-options-summary__row {
            display: flex;
            align-items: center;
            gap: .35rem;
            font-weight: 700;
            color: #0f172a;
        }

        .order-options-summary__label {
            color: #475569;
            font-size: .95rem;
            font-weight: 600;
        }

        .order-options-summary__total {
            font-size: 1.1rem;
        }

        .order-options-modal__footer {
            display: flex;
            justify-content: flex-end;
            gap: .65rem;
        }

        .order-options-btn {
            border: none;
            padding: .65rem 1rem;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
        }

        .order-options-btn--ghost {
            background: #e2e8f0;
            color: #0f172a;
        }

        .order-options-btn--primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
            box-shadow: 0 10px 18px rgba(34, 197, 94, 0.25);
        }

        @@media (max-width: 1024px) {
            .order-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="@bodyStateClass">
    <div class="page-shell">
        <header class="page-header">
            <div class="page-header-left">
                <span class="page-header-hint">接收端</span>
                <div class="shop-card@(hasInitialShopId ? string.Empty : " is-empty")" id="shopCard">
                    <span class="shop-card-label">目前店家</span>
                    <div class="shop-card-value" id="shopDisplayName">
                        @(hasInitialShopId ? "店家資訊載入中..." : "尚未指定店家")
                    </div>
                    <div class="shop-card-id" id="shopIdentifier">
                        @(hasInitialShopId ? initialShopId : "請輸入店家代碼以開始")
                    </div>
                </div>
            </div>
            <div class="@statusClass" id="status">@initialStatusText</div>
        </header>

        <div class="mode-switch" role="tablist" aria-label="頁面模式" id="modeSwitch">
            <button type="button" class="is-active" data-mode="receive" aria-pressed="true">接收訂單</button>
            <button type="button" data-mode="order" aria-pressed="false">點餐</button>
        </div>

        <form class="shop-selector" id="shopSelector" novalidate autocomplete="off">
            <label for="shopInput">切換店家</label>
            <div class="shop-selector-controls">
                <input type="text" id="shopInput" name="shopId" placeholder="輸入店家代碼" value="@(hasInitialShopId ? initialShopId : string.Empty)" />
                <button type="submit" id="shopSubmit">載入</button>
            </div>
        </form>

        <main class="page" id="receiveShell" aria-hidden="@(hasInitialShopId ? "false" : "true")">
            <section class="panel panel-body panel--frameless" id="mainPanel" aria-hidden="false">
                <div class="panel-orders">
                    <div class="orders-filters" role="tablist" aria-label="訂單狀態篩選">
                        <button type="button" class="orders-filter-btn is-active" data-filter="pending" aria-pressed="true">待處理</button>
                        <button type="button" class="orders-filter-btn" data-filter="completed" aria-pressed="false">結單</button>
                        <button type="button" class="orders-filter-btn" data-filter="cancelled" aria-pressed="false">棄單</button>
                    </div>
                    <div class="orders" id="orderUpdates">
                        <div class="orders-empty">尚未接收資料。</div>
                    </div>
                </div>
            </section>

            <section class="panel panel-body order-panel" id="orderPanel" aria-hidden="true" style="display:none;">
                <div class="order-status" id="orderStatus" aria-live="polite">尚未選擇店家，請先於上方輸入店家代碼。</div>

                <div class="order-grid">
                    <div class="order-form-section">
                        <h3 id="orderShopTitle">選擇店家以開始點餐</h3>
                        <div class="order-field">
                            <label>訂單類型</label>
                            <div class="order-type-toggle" id="orderTypeToggle" role="group" aria-label="選擇訂單類型">
                                <button type="button" class="is-active" data-type="DineIn" aria-pressed="true">內用</button>
                                <button type="button" data-type="Takeout" aria-pressed="false">外帶</button>
                            </div>
                        </div>

                        <div class="order-field" id="tableSelectorField">
                            <label for="orderTableSelect">選擇桌號</label>
                            <select id="orderTableSelect" disabled>
                                <option value="">請先選擇店家</option>
                            </select>
                        </div>

                        <div class="order-field" id="takeoutCodeField" style="display:none;">
                            <label for="takeoutCodeInput">外帶代號（選填）</label>
                            <input type="text" id="takeoutCodeInput" maxlength="40" placeholder="例：A001" />
                        </div>

                        <div class="order-field">
                            <label for="orderNotes">備註</label>
                            <textarea id="orderNotes" placeholder="想說的話寫在這裡"></textarea>
                        </div>
                    </div>

                    <div class="order-form-section">
                        <h3>餐點選單</h3>
                        <div class="order-menu" id="orderMenu">
                            <div class="orders-empty">尚未載入餐點。</div>
                        </div>
                    </div>
                </div>

                <div class="order-cart" aria-live="polite">
                    <h3>購物車</h3>
                    <div id="cartItems">
                        <div class="cart-empty">尚未選擇餐點。</div>
                    </div>
                    <div class="order-field">
                        <label for="cartNotes">餐點備註（套用於整張訂單）</label>
                        <textarea id="cartNotes" placeholder="例如：不要香菜、少冰"></textarea>
                    </div>
                    <div class="order-actions">
                        <div class="order-total" id="orderTotal">合計：NT$ 0</div>
                        <button class="order-submit" id="submitOrder" disabled>送出訂單</button>
                    </div>
                </div>
            </section>
        </main>
        <div class="order-options-modal" id="mealOptionsModal" aria-hidden="true">
            <div class="order-options-modal__content" id="mealOptionsContent" role="dialog" aria-modal="true" aria-labelledby="mealOptionsTitle">
                <div class="order-options-modal__header">
                    <h3 class="order-options-modal__title" id="mealOptionsTitle">客製化選項</h3>
                    <button type="button" class="order-options-modal__close" id="mealOptionsClose" aria-label="關閉選項視窗">×</button>
                </div>
                <div class="order-options-modal__body">
                    <div class="order-options-modal__meal" id="mealOptionsName"></div>
                    <div class="order-options-error is-hidden" id="mealOptionsError"></div>
                    <div class="meal-option-groups" id="mealOptionsGroups"></div>
                    <div class="order-options-summary">
                        <div class="order-options-summary__row">
                            <div class="order-options-summary__label">餐點金額</div>
                            <div id="mealOptionsBase">NT$ 0</div>
                        </div>
                        <div class="order-options-summary__row">
                            <div class="order-options-summary__label">客製化</div>
                            <div id="mealOptionsExtra">未加價</div>
                        </div>
                        <div class="order-options-summary__row order-options-summary__total">
                            <div class="order-options-summary__label">合計</div>
                            <div id="mealOptionsTotal">NT$ 0</div>
                        </div>
                    </div>
                </div>
                <div class="order-options-modal__footer">
                    <button type="button" class="order-options-btn order-options-btn--ghost" id="mealOptionsCancel">取消</button>
                    <button type="button" class="order-options-btn order-options-btn--primary" id="mealOptionsConfirm">加入購物車</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        (function () {
            var hub = $.connection.ordersHub;
            var shopInfoUrl = '@Url.Action("ShopInfo")';
            var initialShopId = '@Html.Raw(HttpUtility.JavaScriptStringEncode(initialShopId ?? string.Empty))';
            var hasInitialShop = initialShopId.length > 0;
            var blankClass = 'state-blank';
            var activeClass = 'state-active';
            var $body = $('body');
            var $pageShell = $('#receiveShell');
            var $status = $('#status');
            var $orders = $('#orderUpdates');
            var $shopCard = $('#shopCard');
            var $shopName = $('#shopDisplayName');
            var $shopIdentifier = $('#shopIdentifier');
            var $shopSelector = $('#shopSelector');
            var $shopInput = $('#shopInput');
            var $modeSwitch = $('#modeSwitch');
            var $modeButtons = $modeSwitch.find('button');
            var $receivePanel = $('#mainPanel');
            var $orderPanel = $('#orderPanel');
            var $orderStatus = $('#orderStatus');
            var $orderMenu = $('#orderMenu');
            var $orderShopTitle = $('#orderShopTitle');
            var $orderTableSelect = $('#orderTableSelect');
            var $tableSelectorField = $('#tableSelectorField');
            var $takeoutCodeField = $('#takeoutCodeField');
            var $takeoutCodeInput = $('#takeoutCodeInput');
            var $orderTypeToggle = $('#orderTypeToggle');
            var $orderNotes = $('#orderNotes');
            var $cartNotes = $('#cartNotes');
            var $cartItems = $('#cartItems');
            var $orderTotal = $('#orderTotal');
            var $submitOrder = $('#submitOrder');
            var $mealOptionsModal = $('#mealOptionsModal');
            var $mealOptionsContent = $('#mealOptionsContent');
            var $mealOptionsName = $('#mealOptionsName');
            var $mealOptionsError = $('#mealOptionsError');
            var $mealOptionsGroups = $('#mealOptionsGroups');
            var $mealOptionsBase = $('#mealOptionsBase');
            var $mealOptionsExtra = $('#mealOptionsExtra');
            var $mealOptionsTotal = $('#mealOptionsTotal');
            var $mealOptionsClose = $('#mealOptionsClose');
            var $mealOptionsCancel = $('#mealOptionsCancel');
            var $mealOptionsConfirm = $('#mealOptionsConfirm');
            var isHubReady = false;
            var hasOrders = false;
            var currentShop = null;
            var currentMode = 'receive';
            var orderShopInfo = null;
            var orderState = {
                shopId: hasInitialShop ? initialShopId : null,
                normalizedShopId: hasInitialShop ? initialShopId.toLowerCase() : null,
                shopName: '',
                tables: [],
                categories: [],
                meals: [],
                cart: {},
                orderType: 'DineIn',
                selectedTable: null
            };
            var shopMealsUrl = '@Url.Action("ShopMeals")';
            var shopTablesUrl = '@Url.Action("ShopTables")';
            var orderStatusTextMap = {
                Pending: '待處理',
                Preparing: '準備中',
                Completed: '已結單',
                Cancelled: '已棄單'
            };
            var finalOrderStatuses = {
                Completed: true,
                Cancelled: true
            };
            var statusFilterGroups = {
                pending: {
                    label: '待處理',
                    statuses: { Pending: true, Preparing: true }
                },
                completed: {
                    label: '結單',
                    statuses: { Completed: true }
                },
                cancelled: {
                    label: '棄單',
                    statuses: { Cancelled: true }
                }
            };
            var currentStatusFilterKey = 'pending';
            var $filterButtons = $();
            var $filterEmptyNotice = null;
            var mealOptionsDefaultExtraText = '未加價';
            var pendingMealForOptions = null;
            var pendingMealOptionGroups = [];

            function hideFilterEmptyNotice() {
                if ($filterEmptyNotice && $filterEmptyNotice.length) {
                    $filterEmptyNotice.remove();
                }
                $filterEmptyNotice = null;
            }

            function updateFilterEmptyNotice(totalOrderEntries, visibleOrderEntries) {
                if (totalOrderEntries === 0 || visibleOrderEntries > 0) {
                    hideFilterEmptyNotice();
                    return;
                }

                if (!$filterEmptyNotice) {
                    $filterEmptyNotice = $('<div class="orders-empty orders-empty-filter"/>').text('目前沒有符合條件的訂單。');
                }

                if (!$filterEmptyNotice.parent().length) {
                    $orders.append($filterEmptyNotice);
                }
            }

            function applyStatusFilter() {
                var group = statusFilterGroups[currentStatusFilterKey] || null;
                var totalOrderEntries = 0;
                var visibleOrderEntries = 0;

                $orders.children('.orders-entry').each(function () {
                    var $entry = $(this);
                    var orderId = $entry.attr('data-order-id');
                    if (!orderId) {
                        $entry.removeClass('orders-entry-hidden');
                        return;
                    }

                    totalOrderEntries++;
                    var statusValue = $entry.attr('data-status') || '';
                    var isVisible = !group || group.statuses[statusValue];
                    $entry.toggleClass('orders-entry-hidden', !isVisible);

                    if (isVisible) {
                        visibleOrderEntries++;
                    }
                });

                updateFilterEmptyNotice(totalOrderEntries, visibleOrderEntries);
            }

            function setStatusFilter(key) {
                if (!statusFilterGroups[key]) {
                    return;
                }

                currentStatusFilterKey = key;

                if ($filterButtons && $filterButtons.length) {
                    $filterButtons.removeClass('is-active').attr('aria-pressed', 'false');
                    $filterButtons.filter('[data-filter="' + key + '"]').addClass('is-active').attr('aria-pressed', 'true');
                }

                applyStatusFilter();
            }

              $filterButtons = $('.orders-filter-btn');
              $filterButtons.on('click', function () {
                  var key = $(this).data('filter');
                  setStatusFilter(key);
              });

              setStatusFilter(currentStatusFilterKey);

              function setMode(mode) {
                  var target = mode === 'order' ? 'order' : 'receive';
                  currentMode = target;

                  if ($modeButtons && $modeButtons.length) {
                      $modeButtons.removeClass('is-active').attr('aria-pressed', 'false');
                      $modeButtons.filter('[data-mode="' + target + '"]').addClass('is-active').attr('aria-pressed', 'true');
                  }

                  var isOrderMode = target === 'order';
                  $orderPanel.toggle(isOrderMode).attr('aria-hidden', isOrderMode ? 'false' : 'true');
                  $receivePanel.toggle(!isOrderMode).attr('aria-hidden', isOrderMode ? 'true' : 'false');
              }

              if ($modeButtons && $modeButtons.length) {
                  $modeButtons.on('click', function () {
                      var target = $(this).data('mode');
                      setMode(target);
                  });
              }

              if ($mealOptionsGroups && $mealOptionsGroups.length) {
                  $mealOptionsGroups.on('change', 'input', function () {
                      var groupIndex = parseInt($(this).attr('data-group-index'), 10);
                      enforceGroupLimit(groupIndex);
                      clearMealOptionsError();
                      updateMealOptionsSummary();
                  });
              }

              if ($mealOptionsClose && $mealOptionsClose.length) {
                  $mealOptionsClose.on('click', function () {
                      closeMealOptionsModal();
                  });
              }

              if ($mealOptionsCancel && $mealOptionsCancel.length) {
                  $mealOptionsCancel.on('click', function () {
                      closeMealOptionsModal();
                  });
              }

              if ($mealOptionsConfirm && $mealOptionsConfirm.length) {
                  $mealOptionsConfirm.on('click', function () {
                      var selections = gatherMealOptionSelections();
                      if (selections === null) { return; }
                      var meal = pendingMealForOptions;
                      closeMealOptionsModal();
                      addItemToCart(meal, { selections: selections });
                  });
              }

              if ($mealOptionsModal && $mealOptionsModal.length) {
                  $mealOptionsModal.on('click', function (event) {
                      if (event.target === this) {
                          closeMealOptionsModal();
                      }
                  });
              }

              function setOrderStatus(message, type) {
                  type = type || 'info';
                  var text = $.trim(message || '');

                  if (!$orderStatus || !$orderStatus.length) {
                      return;
                  }

                  $orderStatus.removeClass('is-error is-success');

                  if (!text) {
                      $orderStatus.text('');
                      return;
                  }

                  $orderStatus.text(text);

                  if (type === 'error') {
                      $orderStatus.addClass('is-error');
                  } else if (type === 'success') {
                      $orderStatus.addClass('is-success');
                  }
              }

              function normalizeOptionItem(data) {
                  if (!data) { return null; }

                  var name = '';
                  if (data.name != null) { name = String(data.name).trim(); }
                  else if (data.Name != null) { name = String(data.Name).trim(); }
                  else if (data.title != null) { name = String(data.title).trim(); }
                  else if (data.Title != null) { name = String(data.Title).trim(); }
                  if (!name) { return null; }

                  var priceSource = data.price != null ? data.price :
                      (data.Price != null ? data.Price :
                          (data.money != null ? data.money : data.Money));

                  var price = 0;
                  if (priceSource != null) {
                      var parsed = parseFloat(priceSource);
                      price = isFinite(parsed) ? parsed : 0;
                  }

                  return { name: name, price: price };
              }

              function normalizeOptionGroup(data) {
                  if (!data) { return null; }
                  var name = '';
                  if (data.name != null) { name = String(data.name).trim(); }
                  else if (data.Name != null) { name = String(data.Name).trim(); }
                  else if (data.title != null) { name = String(data.title).trim(); }
                  else if (data.Title != null) { name = String(data.Title).trim(); }
                  if (!name) { return null; }

                  var required = !!(data.required || data.Required || data.isRequired || data.IsRequired);
                  var allowMultiple = !!(data.allowMultiple || data.AllowMultiple || data.multi || data.Multi || data.multiple || data.Multiple || data.allowMulti || data.AllowMulti);

                  var rawMax = null;
                  if (data.maxSelect != null) { rawMax = data.maxSelect; }
                  else if (data.MaxSelect != null) { rawMax = data.MaxSelect; }
                  else if (data.maxSelection != null) { rawMax = data.maxSelection; }
                  else if (data.MaxSelection != null) { rawMax = data.MaxSelection; }
                  else if (data.max != null) { rawMax = data.max; }
                  else if (data.Max != null) { rawMax = data.Max; }
                  else if (data.limit != null) { rawMax = data.limit; }
                  else if (data.Limit != null) { rawMax = data.Limit; }
                  else if (data.maximum != null) { rawMax = data.maximum; }
                  else if (data.Maximum != null) { rawMax = data.Maximum; }

                  var itemsSource = [];
                  if (Array.isArray(data.items)) { itemsSource = data.items; }
                  else if (Array.isArray(data.Items)) { itemsSource = data.Items; }
                  else if (Array.isArray(data.options)) { itemsSource = data.options; }
                  else if (Array.isArray(data.Options)) { itemsSource = data.Options; }
                  else if (Array.isArray(data.choices)) { itemsSource = data.choices; }
                  else if (Array.isArray(data.Choices)) { itemsSource = data.Choices; }

                  var items = [];
                  itemsSource.forEach(function (itemData) {
                      var normalized = normalizeOptionItem(itemData);
                      if (normalized) { items.push(normalized); }
                  });

                  if (!items.length) { return null; }

                  var maxSelect = 1;
                  if (allowMultiple) {
                      var parsedMax = parseInt(rawMax, 10);
                      if (isFinite(parsedMax) && parsedMax > 0) {
                          maxSelect = Math.min(parsedMax, items.length);
                      } else {
                          maxSelect = items.length;
                      }
                  }

                  return {
                      name: name,
                      required: required,
                      allowMultiple: allowMultiple,
                      maxSelect: allowMultiple ? maxSelect : 1,
                      items: items
                  };
              }

              function getMealOptionGroups(meal) {
                  if (!meal) { return []; }
                  if (Array.isArray(meal._normalizedOptions)) { return meal._normalizedOptions; }

                  var raw = meal.optionsJson || meal.OptionsJson || meal.OptionsJSON || '';
                  if (typeof raw === 'string') {
                      raw = raw.trim();
                  }

                  if (!raw) {
                      meal._normalizedOptions = [];
                      return meal._normalizedOptions;
                  }

                  var parsed = null;
                  if (typeof raw === 'string') {
                      try { parsed = JSON.parse(raw); }
                      catch (e) {
                          meal._normalizedOptions = [];
                          return meal._normalizedOptions;
                      }
                  } else if (typeof raw === 'object') {
                      parsed = raw;
                  }

                  if (!parsed) {
                      meal._normalizedOptions = [];
                      return meal._normalizedOptions;
                  }

                  var groupsSource = [];
                  if (Array.isArray(parsed.groups)) { groupsSource = parsed.groups; }
                  else if (Array.isArray(parsed.Groups)) { groupsSource = parsed.Groups; }

                  var normalized = [];
                  groupsSource.forEach(function (groupData) {
                      var normalizedGroup = normalizeOptionGroup(groupData);
                      if (normalizedGroup) { normalized.push(normalizedGroup); }
                  });
                  meal._normalizedOptions = normalized;
                  return normalized;
              }

              function calculateOptionsExtra(selections) {
                  var extra = 0;
                  (selections || []).forEach(function (group) {
                      (group.items || []).forEach(function (option) {
                          extra += Number(option.price) || 0;
                      });
                  });
                  return extra;
              }

              function buildOptionsKey(selections) {
                  if (!Array.isArray(selections) || !selections.length) { return ''; }
                  var parts = [];
                  selections.forEach(function (group) {
                      if (!group || !group.items || !group.items.length) { return; }
                      var itemParts = group.items.map(function (option) {
                          return option.name + String.fromCharCode(64) + (Number(option.price) || 0);
                      }).join('|');
                      parts.push(group.name + ':' + itemParts);
                  });
                  return parts.join(';');
              }

              function buildOptionsNote(selections) {
                  if (!Array.isArray(selections) || !selections.length) { return ''; }
                  var parts = [];
                  selections.forEach(function (group) {
                      if (!group || !group.items || !group.items.length) { return; }
                      var itemTexts = group.items.map(function (option) {
                          var price = Number(option.price) || 0;
                          if (price > 0) {
                              return option.name + '（+' + formatCurrency(price) + '）';
                          }
                          if (price < 0) {
                              return option.name + '（' + formatCurrency(price) + '）';
                          }
                          return option.name;
                      });
                      parts.push(group.name + '：' + itemTexts.join('、'));
                  });
                  return parts.join('；');
              }

              function clearMealOptionsError() {
                  $mealOptionsError.text('').addClass('is-hidden');
              }

              function showMealOptionsError(message) {
                  $mealOptionsError.text(message || '').removeClass('is-hidden');
              }

              function resetMealOptionsModal() {
                  pendingMealForOptions = null;
                  pendingMealOptionGroups = [];
                  $mealOptionsName.text('');
                  $mealOptionsGroups.empty();
                  $mealOptionsBase.text(formatCurrency(0));
                  $mealOptionsExtra.text(mealOptionsDefaultExtraText);
                  $mealOptionsTotal.text(formatCurrency(0));
                  clearMealOptionsError();
              }

              function updateMealOptionsSummary() {
                  var basePrice = pendingMealForOptions ? Number(pendingMealForOptions.money || pendingMealForOptions.price || 0) : 0;
                  var extra = 0;
                  $mealOptionsGroups.find('input:checked').each(function () {
                      var groupIndex = parseInt($(this).attr('data-group-index'), 10);
                      var optionIndex = parseInt($(this).attr('data-option-index'), 10);
                      var group = pendingMealOptionGroups[groupIndex];
                      if (!group) { return; }
                      var option = group.items[optionIndex];
                      if (!option) { return; }
                      extra += Number(option.price) || 0;
                  });
                  $mealOptionsBase.text(formatCurrency(basePrice));
                  if (extra > 0) {
                      $mealOptionsExtra.text('＋' + formatCurrency(extra));
                  } else if (extra < 0) {
                      $mealOptionsExtra.text(formatCurrency(extra));
                  } else {
                      $mealOptionsExtra.text(mealOptionsDefaultExtraText);
                  }
                  $mealOptionsTotal.text(formatCurrency(basePrice + extra));
              }

              function enforceGroupLimit(groupIndex) {
                  var group = pendingMealOptionGroups[groupIndex];
                  if (!group || !group.allowMultiple) { return; }
                  var $group = $mealOptionsGroups.find('.meal-option-group[data-index="' + groupIndex + '"]');
                  var $checked = $group.find('input:checked');
                  if ($checked.length > group.maxSelect) {
                      $checked.last().prop('checked', false);
                  }
              }

              function renderMealOptionGroups(groups) {
                  $mealOptionsGroups.empty();
                  if (!groups.length) {
                      $mealOptionsGroups.append($('<div class="cart-empty"/>').text('此餐點沒有額外選項。'));
                      return;
                  }

                  groups.forEach(function (group, groupIndex) {
                      var $group = $('<div class="meal-option-group"/>').attr('data-index', groupIndex);
                      var $header = $('<div class="meal-option-group__header"/>').appendTo($group);
                      $('<div class="meal-option-group__name"/>').text(group.name).appendTo($header);
                      var metaParts = [];
                      metaParts.push(group.required ? '必選' : '可不選');
                      metaParts.push(group.allowMultiple ? ('最多選 ' + group.maxSelect + ' 項') : '限選 1 項');
                      $('<div class="meal-option-group__meta"/>').text(metaParts.join('｜')).appendTo($header);

                      var $items = $('<div class="meal-option-items"/>').appendTo($group);
                      var inputName = 'mealOptionGroup' + groupIndex;
                      var inputType = group.allowMultiple ? 'checkbox' : 'radio';

                      group.items.forEach(function (option, optionIndex) {
                          var inputId = 'mealOption-' + groupIndex + '-' + optionIndex;
                          var $label = $('<label class="meal-option-item"/>').attr('for', inputId);
                          var $input = $('<input/>', {
                              type: inputType,
                              id: inputId,
                              name: inputName
                          }).attr('data-group-index', groupIndex).attr('data-option-index', optionIndex);
                          var $info = $('<div class="meal-option-item__label"/>');
                          $('<div class="meal-option-item__name"/>').text(option.name).appendTo($info);
                          var price = Number(option.price) || 0;
                          var priceText = price > 0 ? ('＋' + formatCurrency(price)) : (price < 0 ? formatCurrency(price) : '不加價');
                          $('<div class="meal-option-item__price"/>').text(priceText).appendTo($info);
                          $label.append($input).append($info);
                          $items.append($label);
                      });

                      $mealOptionsGroups.append($group);
                  });
              }

              function gatherMealOptionSelections() {
                  if (!pendingMealOptionGroups.length) { return []; }
                  var selections = [];
                  var hasError = false;

                  pendingMealOptionGroups.forEach(function (group, groupIndex) {
                      if (hasError) { return; }
                      var $group = $mealOptionsGroups.find('.meal-option-group[data-index="' + groupIndex + '"]');
                      var $checked = $group.find('input:checked');
                      if (group.required && !$checked.length) {
                          showMealOptionsError('「' + group.name + '」為必選項目。');
                          $group.find('input').first().trigger('focus');
                          hasError = true;
                          return;
                      }

                      if ($checked.length > group.maxSelect) {
                          showMealOptionsError('「' + group.name + '」最多可選 ' + group.maxSelect + ' 項。');
                          hasError = true;
                          return;
                      }

                      if (!$checked.length) { return; }

                      var selectedItems = [];
                      $checked.each(function () {
                          var optionIndex = parseInt($(this).attr('data-option-index'), 10);
                          var option = group.items[optionIndex];
                          if (option) {
                              selectedItems.push({ name: option.name, price: Number(option.price) || 0 });
                          }
                      });

                      if (selectedItems.length) {
                          selections.push({ name: group.name, items: selectedItems });
                      }
                  });

                  if (hasError) { return null; }
                  return selections;
              }

              function openMealOptionsModal(meal, groups) {
                  resetMealOptionsModal();
                  pendingMealForOptions = meal;
                  pendingMealOptionGroups = groups;
                  $mealOptionsName.text(meal.name || '');
                  renderMealOptionGroups(groups);
                  clearMealOptionsError();
                  updateMealOptionsSummary();
                  $mealOptionsModal.addClass('is-active').attr('aria-hidden', 'false');
                  setTimeout(function () {
                      $mealOptionsContent.trigger('focus');
                  }, 0);
              }

              function closeMealOptionsModal() {
                  $mealOptionsModal.removeClass('is-active').attr('aria-hidden', 'true');
                  resetMealOptionsModal();
              }

              function handleMealAdd(meal) {
                  var optionGroups = getMealOptionGroups(meal);
                  if (!optionGroups.length) {
                      addItemToCart(meal);
                      return;
                  }

                  openMealOptionsModal(meal, optionGroups);
              }

              function resetOrderPanel(options) {
                  options = options || {};
                  orderState.cart = {};
                  orderState.tables = [];
                  orderState.meals = [];
                  orderState.categories = [];
                  orderState.selectedTable = null;

                  if ($orderMenu && $orderMenu.length) {
                      $orderMenu.empty().append($('<div class="orders-empty"/>').text('尚未載入餐點。'));
                  }

                  if ($orderTableSelect && $orderTableSelect.length) {
                      $orderTableSelect.prop('disabled', true).empty();
                      $orderTableSelect.append($('<option/>').text(options.tablePlaceholder || '請先選擇店家').val(''));
                  }

                  if ($orderShopTitle && $orderShopTitle.length) {
                      $orderShopTitle.text(options.shopTitle || '選擇店家以開始點餐');
                  }

                  renderCart();
                  updateSubmitState();

                  if (!options.silent) {
                      setOrderStatus('尚未選擇店家，請先於上方輸入店家代碼。');
                  }
              }

              function updateSubmitState() {
                  var hasItems = Object.keys(orderState.cart || {}).length > 0;
                  var requiresTable = orderState.orderType !== 'Takeout';
                  var hasTable = !requiresTable || (orderState.selectedTable && orderState.selectedTable.id);
                  var canSubmit = hasItems && hasTable;

                  if ($submitOrder && $submitOrder.length) {
                      $submitOrder.prop('disabled', !canSubmit);
                  }
              }

              function renderCart() {
                  if (!$cartItems || !$cartItems.length) {
                      return;
                  }

                  $cartItems.empty();
                  var total = 0;
                  var entries = [];

                  Object.keys(orderState.cart || {}).forEach(function (key) {
                      var item = orderState.cart[key];
                      if (!item || item.qty <= 0) {
                          return;
                      }

                      entries.push($.extend({}, item, { key: key }));
                  });

                  if (!entries.length) {
                      $cartItems.append($('<div class="cart-empty"/>').text('尚未選擇餐點。'));
                      $orderTotal.text('合計：NT$ 0');
                      updateSubmitState();
                      return;
                  }

                  entries.forEach(function (item) {
                      var cartKey = item.key || item.id;
                      var lineTotal = (Number(item.price) || 0) * (Number(item.qty) || 0);
                      total += lineTotal;

                      var $row = $('<div class="cart-item"/>');
                      var $info = $('<div/>');
                      $info.append($('<strong/>').text(item.name || '餐點'));
                      if (item.optionsNote) {
                          $info.append($('<div class="cart-item-note"/>').text(item.optionsNote));
                      }
                      $info.append($('<div class="meal-meta"/>').text('單價：' + formatCurrency(item.price)));
                      $row.append($info);

                      var $controls = $('<div class="cart-item-controls"/>');
                      var $minus = $('<button type="button" aria-label="減少">-</button>');
                      var $qty = $('<span/>').text('× ' + item.qty);
                      var $plus = $('<button type="button" aria-label="增加">+</button>');

                      $minus.on('click', function () {
                          changeCartQuantity(cartKey, -1);
                      });

                      $plus.on('click', function () {
                          changeCartQuantity(cartKey, 1);
                      });

                      $controls.append($minus, $qty, $plus);
                      $row.append($controls);
                      $cartItems.append($row);
                  });

                  $orderTotal.text('合計：' + formatCurrency(total));
                  updateSubmitState();
              }

              function changeCartQuantity(key, delta) {
                  if (!key || !delta) {
                      return;
                  }

                  var item = orderState.cart[key];
                  if (!item) {
                      return;
                  }

                  var nextQty = (Number(item.qty) || 0) + delta;
                  if (nextQty <= 0) {
                      delete orderState.cart[key];
                  } else {
                      item.qty = nextQty;
                  }

                  renderCart();
              }

              function addItemToCart(meal, options) {
                  options = options || {};
                  if (!meal || !meal.id) {
                      return;
                  }

                  var selections = Array.isArray(options.selections) ? options.selections : [];
                  var basePrice = Number(meal.money || meal.price || 0) || 0;
                  var optionsKey = buildOptionsKey(selections);
                  var optionsNote = buildOptionsNote(selections) || null;
                  var optionsExtra = calculateOptionsExtra(selections);
                  var unitPrice = basePrice + optionsExtra;
                  var mealId = meal.id.toString();
                  var cartKey = mealId + (optionsKey ? '::' + optionsKey : '');
                  var existing = orderState.cart[cartKey] || { id: cartKey, key: cartKey, mealId: mealId, name: meal.name || '餐點', price: unitPrice, qty: 0 };
                  existing.price = unitPrice;
                  existing.basePrice = basePrice;
                  existing.name = meal.name || existing.name;
                  existing.optionsNote = optionsNote;
                  existing.optionsKey = optionsKey;
                  existing.optionsExtra = optionsExtra;
                  existing.qty = (Number(existing.qty) || 0) + 1;
                  orderState.cart[cartKey] = existing;

                  renderCart();
              }

              function updateOrderType(type) {
                  var orderType = type === 'Takeout' ? 'Takeout' : 'DineIn';
                  orderState.orderType = orderType;

                  if ($orderTypeToggle && $orderTypeToggle.length) {
                      $orderTypeToggle.find('button').removeClass('is-active').attr('aria-pressed', 'false');
                      $orderTypeToggle.find('button[data-type="' + orderType + '"]').addClass('is-active').attr('aria-pressed', 'true');
                  }

                  if (orderType === 'Takeout') {
                      $tableSelectorField.hide();
                      $takeoutCodeField.show();
                  } else {
                      $tableSelectorField.show();
                      $takeoutCodeField.hide();
                  }

                  updateSubmitState();
              }

              if ($orderTypeToggle && $orderTypeToggle.length) {
                  $orderTypeToggle.find('button').on('click', function () {
                      var type = $(this).data('type');
                      updateOrderType(type);
                  });
              }

              function renderMenu() {
                  if (!$orderMenu || !$orderMenu.length) {
                      return;
                  }

                  $orderMenu.empty();

                  if (!orderState.meals || !orderState.meals.length) {
                      $orderMenu.append($('<div class="orders-empty"/>').text('目前沒有可用餐點。'));
                      return;
                  }

                  var categoryMap = {};
                  (orderState.categories || []).forEach(function (cat) {
                      var key = (cat.id || 'uncategorized').toString();
                      categoryMap[key] = cat.name || '其他';
                  });

                  var grouped = {};
                  orderState.meals.forEach(function (meal) {
                      var key = meal.categoryId ? meal.categoryId.toString() : 'uncategorized';
                      if (!grouped[key]) {
                          grouped[key] = [];
                      }
                      grouped[key].push(meal);
                  });

                  Object.keys(grouped).forEach(function (key) {
                      var meals = grouped[key];
                      if (!meals || !meals.length) {
                          return;
                      }

                      var title = categoryMap[key] || '其他';
                      var $section = $('<div class="order-menu-section"/>');
                      $section.append($('<h4/>').text(title));

                      meals.forEach(function (meal) {
                          var $card = $('<div class="meal-card"/>');
                          $card.append($('<h4/>').text(meal.name || '餐點'));
                          $card.append($('<div class="meal-meta"/>').text(formatCurrency(meal.money)));
                          if (meal.element) {
                              $card.append($('<div class="meal-meta"/>').text(meal.element));
                          }
                          var $btn = $('<button type="button"/>').text('加入').on('click', function () {
                              handleMealAdd(meal);
                          });
                          $card.append($btn);
                          $section.append($card);
                      });

                      $orderMenu.append($section);
                  });
              }

              function updateTableOptions(tables) {
                  if (!$orderTableSelect || !$orderTableSelect.length) {
                      return;
                  }

                  $orderTableSelect.empty();
                  orderState.selectedTable = null;

                  if (!tables || !tables.length) {
                      $orderTableSelect.append($('<option/>').val('').text('沒有可用桌號'));
                      $orderTableSelect.prop('disabled', true);
                      updateSubmitState();
                      return;
                  }

                  $orderTableSelect.append($('<option/>').val('').text('請選擇桌號'));
                  tables.forEach(function (table) {
                      var label = '桌號 ' + table.number;
                      if (table.zone) {
                          label += '（' + table.zone + '）';
                      }

                      var $option = $('<option/>')
                          .val(table.id)
                          .text(label)
                          .attr('data-number', table.number)
                          .attr('data-zone', table.zone || '');

                      $orderTableSelect.append($option);
                  });

                  $orderTableSelect.prop('disabled', false);
                  updateSubmitState();
              }

              if ($orderTableSelect && $orderTableSelect.length) {
                  $orderTableSelect.on('change', function () {
                      var value = $(this).val();
                      var selected = null;
                      (orderState.tables || []).some(function (table) {
                          if (table.id && table.id.toString() === value) {
                              selected = table;
                              return true;
                          }
                          return false;
                      });

                      orderState.selectedTable = selected;
                      updateSubmitState();
                  });
              }

              function loadTablesForShop(shopId) {
                  if (!shopId) {
                      updateTableOptions([]);
                      return;
                  }

                  $orderTableSelect.prop('disabled', true).empty().append($('<option/>').text('桌號載入中...'));

                  $.getJSON(shopTablesUrl, { shopId: shopId })
                      .done(function (res) {
                          if (res && res.ok) {
                              orderState.tables = res.items || [];
                              updateTableOptions(orderState.tables);
                          } else {
                              orderState.tables = [];
                              updateTableOptions([]);
                              setOrderStatus((res && res.error) ? res.error : '無法載入桌號。', 'error');
                          }
                      })
                      .fail(function () {
                          orderState.tables = [];
                          updateTableOptions([]);
                          setOrderStatus('讀取桌號時發生錯誤。', 'error');
                      });
              }

              function loadMealsForShop(shopId) {
                  if (!shopId) {
                      orderState.meals = [];
                      orderState.categories = [];
                      renderMenu();
                      return;
                  }

                  $orderMenu.empty().append($('<div class="orders-empty"/>').text('餐點載入中...'));

                  $.getJSON(shopMealsUrl, { shopId: shopId })
                      .done(function (res) {
                          if (res && res.ok) {
                              orderState.meals = res.items || [];
                              orderState.categories = res.categories || [];
                              renderMenu();
                              setOrderStatus('餐點已載入完成。', 'success');
                          } else {
                              orderState.meals = [];
                              orderState.categories = [];
                              renderMenu();
                              setOrderStatus((res && res.error) ? res.error : '讀取餐點時發生錯誤。', 'error');
                          }
                      })
                      .fail(function () {
                          orderState.meals = [];
                          orderState.categories = [];
                          renderMenu();
                          setOrderStatus('讀取餐點時發生錯誤。', 'error');
                      });
              }

              function refreshOrderFrame(options) {
                  options = options || {};
                  var targetRawId = $.trim(options.shopId || '');
                  var shouldForce = !!options.force;

                  if (!targetRawId) {
                      orderState.shopId = null;
                      orderState.normalizedShopId = null;
                      orderShopInfo = null;
                      resetOrderPanel({ silent: options.silent });
                      return;
                  }

                  var normalized = normalizeShopId(targetRawId);
                  if (!shouldForce && orderState.normalizedShopId === normalized) {
                      return;
                  }

                  orderState.shopId = targetRawId;
                  orderState.normalizedShopId = normalized;
                  orderState.cart = {};
                  renderCart();
                  setOrderStatus('正在載入店家資訊…');
                  $orderShopTitle.text('正在載入店家資訊…');

                  loadTablesForShop(targetRawId);
                  loadMealsForShop(targetRawId);

                  $.getJSON(shopInfoUrl, { id: targetRawId })
                      .done(function (res) {
                          if (res && res.ok && res.shop) {
                              orderShopInfo = res.shop;
                              orderState.shopName = res.shop.name || '';
                              var name = res.shop.name || targetRawId;
                              $orderShopTitle.text('目前店家：' + name);
                              setOrderStatus('店家資訊已載入。', 'success');
                          } else {
                              orderShopInfo = null;
                              orderState.shopName = '';
                              setOrderStatus(res && res.error ? res.error : '沒有此店家', 'error');
                              resetOrderPanel({ silent: true, shopTitle: '沒有此店家', tablePlaceholder: '沒有可用桌號' });
                          }
                      })
                      .fail(function () {
                          orderShopInfo = null;
                          orderState.shopName = '';
                          setOrderStatus('讀取店家資訊時發生錯誤。', 'error');
                          resetOrderPanel({ silent: true });
                      });
              }

              function sendOrder() {
                  if (!isHubReady) {
                      setOrderStatus('SignalR 尚未連線完成，請稍候。', 'error');
                      return;
                  }

                  if (!orderState.shopId) {
                      setOrderStatus('請先選擇店家。', 'error');
                      return;
                  }

                  var payloadItems = [];
                  Object.keys(orderState.cart || {}).forEach(function (key) {
                      var entry = orderState.cart[key];
                      if (!entry || entry.qty <= 0) {
                          return;
                      }

                      payloadItems.push({
                          MealId: entry.mealId || entry.id,
                          Name: entry.name,
                          Qty: entry.qty,
                          Price: entry.price,
                          Notes: entry.optionsNote || null
                      });
                  });

                  if (!payloadItems.length) {
                      setOrderStatus('請先選擇至少一項餐點。', 'error');
                      return;
                  }

                  var orderType = orderState.orderType === 'Takeout' ? 'Takeout' : 'DineIn';
                  var takeoutCode = null;
                  var selectedTable = orderState.selectedTable;

                  if (orderType === 'DineIn') {
                      if (!selectedTable || !selectedTable.id) {
                          setOrderStatus('內用時請先選擇桌號。', 'error');
                          return;
                      }
                  } else {
                      takeoutCode = $.trim($takeoutCodeInput.val() || '');
                      selectedTable = null;
                  }

                  var notesA = $.trim($orderNotes.val() || '');
                  var notesB = $.trim($cartNotes.val() || '');
                  var notes = null;
                  if (notesA && notesB) {
                      notes = notesA + '\n' + notesB;
                  } else {
                      notes = notesA || notesB || null;
                  }

                  var dto = {
                      ShopId: orderState.shopId,
                      ShopName: orderState.shopName || (currentShop && currentShop.name) || null,
                      Items: payloadItems,
                      Notes: notes,
                      OrderType: orderType
                  };

                  if (orderType === 'DineIn' && selectedTable) {
                      dto.TableId = selectedTable.id;
                      dto.TableNumber = selectedTable.number;
                      dto.TableZone = selectedTable.zone;
                  } else if (orderType === 'Takeout' && takeoutCode) {
                      dto.TakeoutCode = takeoutCode;
                  }

                  $submitOrder.prop('disabled', true).text('送出中...');

                  hub.server.createOrder(dto)
                      .done(function () {
                          setOrderStatus('訂單已送出，請留意訂單通知。', 'success');
                          orderState.cart = {};
                          renderCart();
                      })
                      .fail(function () {
                          setOrderStatus('送出訂單失敗，請稍後再試。', 'error');
                      })
                      .always(function () {
                          $submitOrder.prop('disabled', false).text('送出訂單');
                      });
              }

              if ($submitOrder && $submitOrder.length) {
                  $submitOrder.on('click', function (event) {
                      event.preventDefault();
                      sendOrder();
                  });
              }

              setMode('receive');
              updateOrderType('DineIn');
              renderCart();

              if ($shopSelector && $shopSelector.length) {
                  $shopSelector.on('submit', function (event) {
                      event.preventDefault();
                      var value = $shopInput.length ? $shopInput.val() : '';
                      subscribeToShop(value);
                  });
              }

            function isInterfaceVisible() {
                return !$body.hasClass(blankClass);
            }

            function showInterface() {
                $body.removeClass(blankClass);
                if (!$body.hasClass(activeClass)) {
                    $body.addClass(activeClass);
                }
                $pageShell.attr('aria-hidden', 'false');
            }

            function hideInterface() {
                $body.removeClass(activeClass).addClass(blankClass);
                $pageShell.attr('aria-hidden', 'true');
            }

            function setStatus(message, type) {
                type = type || 'info';
                var text = $.trim(message || '');

                if (!text) {
                    $status.addClass('is-hidden').removeClass('info success error').text('');
                    return;
                }

                $status.removeClass('is-hidden info success error').addClass(type).text(text);
            }

            function formatTimestamp(date) {
                return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0')
                    + ' ' + String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0') + ':' + String(date.getSeconds()).padStart(2, '0');
            }

            function formatCurrency(value) {
                return 'NT$ ' + (Number(value) || 0).toLocaleString('zh-TW');
            }

            function getNumericValue(value) {
                var number = Number(value);
                return isFinite(number) ? number : null;
            }

            function resolveTimestamp(value) {
                if (!value) {
                    return new Date();
                }

                var date = new Date(value);
                if (isNaN(date.getTime())) {
                    return new Date();
                }

                return date;
            }

            function getOrderStatusText(status) {
                var key = $.trim(status || '');
                return orderStatusTextMap[key] || key || '未知狀態';
            }

            function getOrderStatusClass(status) {
                switch (status) {
                    case 'Pending':
                        return 'is-pending';
                    case 'Preparing':
                        return 'is-preparing';
                    case 'Completed':
                        return 'is-completed';
                    case 'Cancelled':
                        return 'is-cancelled';
                    default:
                        return '';
                }
            }

            function shortenGuid(value) {
                var text = (value || '').toString();
                if (text.length <= 8) {
                    return text;
                }

                return text.slice(0, 4) + '…' + text.slice(-4);
            }

            function getOrderEntryLabel($entry, orderId) {
                if ($entry && $entry.length) {
                    var label = $entry.attr('data-order-label');
                    if (label) {
                        return label;
                    }

                    var tableNumber = $entry.attr('data-table-number');
                    if (tableNumber) {
                        return '桌號 ' + tableNumber;
                    }
                }

                if (!orderId) {
                    return '訂單';
                }

                return '訂單 #' + shortenGuid(orderId);
            }

            function setEntryActionsDisabled($entry, disabled) {
                if (!$entry || !$entry.length) {
                    return;
                }

                var isDisabled = !!disabled;
                $entry.toggleClass('order-entry-disabled', isDisabled);
                $entry.find('.order-action-btn').prop('disabled', isDisabled);
            }

            function updateEntryStatus(orderId, status, options) {
                options = options || {};

                var $entry = orderId ? $orders.find('.orders-entry[data-order-id="' + orderId + '"]') : $();
                var statusText = getOrderStatusText(status);
                var statusClass = getOrderStatusClass(status);

                if ($entry.length) {
                    var $chip = $entry.find('.orders-entry-status-chip');
                    if ($chip.length) {
                        $chip
                            .text(statusText)
                            .removeClass('is-pending is-preparing is-completed is-cancelled');

                        if (statusClass) {
                            $chip.addClass(statusClass);
                        }
                    }

                    $entry.attr('data-status', status || '');

                    if (finalOrderStatuses[status]) {
                        setEntryActionsDisabled($entry, true);
                    } else if (!options.keepDisabled) {
                        setEntryActionsDisabled($entry, false);
                    }
                }

                var suppressNotice = false;
                if ($entry.length && $entry.data('suppress-status-notice')) {
                    suppressNotice = true;
                    $entry.removeData('suppress-status-notice');
                }

                if (options.notify === false || suppressNotice) {
                    applyStatusFilter();
                    return;
                }

                var label = getOrderEntryLabel($entry, orderId);
                var ts = options.timestamp instanceof Date ? formatTimestamp(options.timestamp) : null;
                applyStatusFilter();
            }

            function requestOrderStatusChange(orderId, status, $entry) {
                if (!orderId) {
                    appendStatus('缺少訂單識別碼，無法更新狀態。');
                    return;
                }

                if (!currentShop || !currentShop.rawId) {
                    appendStatus('尚未選擇店家，無法更新訂單狀態。');
                    return;
                }

                if (!hub || !hub.server || typeof hub.server.updateOrderStatus !== 'function') {
                    appendStatus('連線尚未就緒，請稍候。');
                    return;
                }

                if ($entry && $entry.length) {
                    $entry.data('suppress-status-notice', true);
                }

                setEntryActionsDisabled($entry, true);

                hub.server.updateOrderStatus(currentShop.rawId, orderId, status)
                    .done(function (result) {
                        if (!result || result.ok === false) {
                            var message = (result && result.error) ? result.error : '更新訂單狀態失敗。';
                            appendStatus(message);
                            setEntryActionsDisabled($entry, false);
                            if ($entry && $entry.length) {
                                $entry.removeData('suppress-status-notice');
                            }
                        }
                    })
                    .fail(function () {
                        appendStatus('更新訂單狀態時發生錯誤，請稍後再試。');
                        setEntryActionsDisabled($entry, false);
                        if ($entry && $entry.length) {
                            $entry.removeData('suppress-status-notice');
                        }
                    });
            }

            function resetOrders() {
                hasOrders = false;
                $orders.empty().append($('<div class="orders-empty"/>').text('尚未接收資料。'));
                hideFilterEmptyNotice();
            }

            function ensureOrdersContainer() {
                if (!hasOrders) {
                    $orders.empty();
                    hasOrders = true;
                }

                hideFilterEmptyNotice();
            }

            function appendStatus(message) {
                if (!isInterfaceVisible()) {
                    return;
                }

                ensureOrdersContainer();
                var now = new Date();
                var $entry = $('<div class="orders-entry"/>');
                $entry.append($('<div class="orders-entry-time"/>').text(formatTimestamp(now)));
                $entry.append($('<div class="orders-entry-title orders-entry-status"/>').text(message));
                $orders.append($entry);
                $orders.scrollTop($orders[0].scrollHeight);
                applyStatusFilter();
            }

            function appendOrderNotification(payload) {
                if (!isInterfaceVisible()) {
                    return;
                }

                if (payload && payload.type === 'statusChanged') {
                    var orderInfo = payload.order || {};
                    var orderId = payload.orderId || orderInfo.id;
                    var statusValue = payload.status || orderInfo.status;
                    var ts = resolveTimestamp(payload.ts || (orderInfo && orderInfo.updatedAt));
                    updateEntryStatus(orderId, statusValue, { timestamp: ts });
                    return;
                }

                ensureOrdersContainer();
                var now = resolveTimestamp(payload && payload.ts);
                var $entry = $('<div class="orders-entry"/>');
                $entry.append($('<div class="orders-entry-time"/>').text(formatTimestamp(now)));
                var isNewOrderEntry = false;

                if (!payload) {
                    $entry.append($('<div class="orders-entry-title"/>').text('收到未知通知。'));
                    $orders.append($entry);
                    $orders.scrollTop($orders[0].scrollHeight);
                    return;
                }

                if (payload.type === 'error') {
                    var errorText = payload.error || '發生錯誤。';
                    $entry.append($('<div class="orders-entry-title"/>').text('訂單處理錯誤'));
                    $entry.append($('<div class="orders-entry-body"/>').text(errorText));
                    $orders.append($entry);
                    $orders.scrollTop($orders[0].scrollHeight);
                    return;
                }

                if (payload.type === 'created' && payload.dto) {
                    var dto = payload.dto || {};
                    var order = payload.order || {};
                    var orderId = order.id || null;
                    var header = '收到新訂單';
                    var entryLabel = null;
                    var totalAmount = getNumericValue(dto.totalAmount);
                    if (totalAmount === null) {
                        totalAmount = getNumericValue(dto.total);
                    }
                    if (totalAmount === null && order) {
                        totalAmount = getNumericValue(order.totalAmount);
                        if (totalAmount === null) {
                            totalAmount = getNumericValue(order.total);
                        }
                    }
                    var aggregatedTotal = 0;
                    var hasAggregatedTotal = false;
                    if (dto.tableNumber) {
                        header += '（桌號 ' + dto.tableNumber + '）';
                        $entry.attr('data-table-number', dto.tableNumber);
                        entryLabel = '桌號 ' + dto.tableNumber;
                    }
                    if (orderId) {
                        $entry.attr('data-order-id', orderId);
                        if (!entryLabel) {
                            entryLabel = '訂單 #' + shortenGuid(orderId);
                        }
                    }
                    if (!entryLabel) {
                        entryLabel = header;
                    }
                    $entry.attr('data-order-label', entryLabel);
                    $entry.append($('<div class="orders-entry-title"/>').text(header));
                    if (dto.shopName) {
                        $entry.append($('<div class="orders-entry-meta"/>').text('餐廳：' + dto.shopName));
                    }
                    if (dto.items && dto.items.length) {
                        var $items = $('<ul class="orders-entry-items"/>');
                        dto.items.forEach(function (item) {
                            var line = item.name || '餐點';
                            if (item.qty) {
                                line += ' × ' + item.qty;
                            }
                            if (item.price !== undefined && item.price !== null) {
                                line += '（' + formatCurrency(item.price) + '）';
                            }

                            var $item = $('<li/>');
                            $item.append($('<span class="orders-entry-item-main"/>').text(line));

                            var itemNotes = $.trim(item.notes || '');
                            if (itemNotes) {
                                $item.append($('<div class="orders-entry-item-note"/>').text(itemNotes));
                            }

                            $item.appendTo($items);

                            if (totalAmount === null) {
                                var itemTotal = getNumericValue(item.total);
                                var itemPrice = getNumericValue(item.price);
                                var itemQty = getNumericValue(item.qty);

                                if (itemTotal === null && itemPrice !== null) {
                                    if (itemQty !== null && itemQty > 0) {
                                        itemTotal = itemPrice * itemQty;
                                    } else {
                                        itemTotal = itemPrice;
                                    }
                                }

                                if (itemTotal !== null) {
                                    aggregatedTotal += itemTotal;
                                    hasAggregatedTotal = true;
                                }
                            }
                        });
                        $entry.append($items);
                    }
                    if (dto.notes) {
                        $entry.append($('<div class="orders-entry-note"/>').text('備註：' + dto.notes));
                    }

                    if (totalAmount === null && hasAggregatedTotal) {
                        totalAmount = aggregatedTotal;
                    }

                    if (totalAmount !== null) {
                        $entry.append($('<div class="orders-entry-meta orders-entry-total"/>').text('總金額：' + formatCurrency(totalAmount)));
                    }

                    var statusValue = order.status || 'Pending';
                    var statusClass = getOrderStatusClass(statusValue);
                    var $statusLine = $('<div class="orders-entry-statusline"/>');
                    $statusLine.append($('<span/>').text('狀態：'));
                    var $chip = $('<span class="orders-entry-status-chip"/>').text(getOrderStatusText(statusValue));
                    if (statusClass) {
                        $chip.addClass(statusClass);
                    }
                    $statusLine.append($chip);
                    $entry.append($statusLine);

                    if (orderId) {
                        var actions = [
                            { status: 'Completed', label: '結單', className: 'complete' },
                            { status: 'Cancelled', label: '棄單', className: 'cancel' }
                        ];
                        var $actions = $('<div class="orders-entry-actions"/>');
                        actions.forEach(function (action) {
                            var $btn = $('<button type="button" class="order-action-btn"/>')
                                .addClass(action.className)
                                .text(action.label)
                                .on('click', function () {
                                    requestOrderStatusChange(orderId, action.status, $entry);
                                });
                            $actions.append($btn);
                        });
                        $entry.append($actions);
                    }

                    isNewOrderEntry = true;
                } else {
                    var details = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2);
                    $entry.append($('<div class="orders-entry-title"/>').text('收到通知'));
                    $entry.append($('<pre class="orders-entry-body"/>').text(details));
                }

                if (isNewOrderEntry) {
                    $orders.prepend($entry);
                    $orders.scrollTop(0);
                    updateEntryStatus(orderId, statusValue, { notify: false, keepDisabled: !!finalOrderStatuses[statusValue] });
                } else {
                    $orders.append($entry);
                    $orders.scrollTop($orders[0].scrollHeight);
                }

                applyStatusFilter();
            }

            function normalizeShopId(value) {
                return (value || '').toString().toLowerCase();
            }

            function updateShopCard(name, rawId, options) {
                options = options || {};
                var state = options.state || '';
                var placeholderName = options.placeholderName || '';
                var placeholderId = options.placeholderId || '';

                $shopCard.removeClass('is-empty is-loading is-error');

                if (state === 'loading') {
                    $shopCard.addClass('is-loading');
                } else if (state === 'error') {
                    $shopCard.addClass('is-error');
                } else if (!rawId) {
                    $shopCard.addClass('is-empty');
                }

                if (rawId) {
                    $shopName.text(name || rawId);
                    $shopIdentifier.text(rawId);
                } else {
                    $shopName.text(name || placeholderName);
                    $shopIdentifier.text(placeholderId);
                }

                if ($shopInput && $shopInput.length) {
                    if (rawId) {
                        $shopInput.val(rawId);
                    } else if (placeholderId) {
                        $shopInput.val(placeholderId);
                    } else if (!options.keepInputValue) {
                        $shopInput.val('');
                    }
                }

                if (rawId || options.keepVisible) {
                    showInterface();
                } else {
                    hideInterface();
                }
            }

            function subscribeToShop(shopId) {
                if (!isHubReady) {
                    if (shopId) {
                        setStatus('SignalR 尚未連線完成，請稍候。', 'error');
                    }
                    return;
                }

                shopId = $.trim(shopId || '');
                if (!shopId) {
                    currentShop = null;
                    hideInterface();
                    resetOrders();
                    setStatus('');
                    refreshOrderFrame({ shopId: null, force: true });
                    return;
                }

                updateShopCard('店家資訊載入中...', shopId, { state: 'loading', keepVisible: true });
                setStatus('正在讀取店家資訊，請稍候。', 'info');

                $.getJSON(shopInfoUrl, { id: shopId })
                    .done(function (res) {
                        if (!res || !res.ok || !res.shop || !res.shop.id) {
                            var message = res && res.error ? res.error : '沒有此店家';
                            currentShop = null;
                            setStatus(message, 'error');
                            updateShopCard(message, null, { state: 'error', keepVisible: true, placeholderId: shopId });
                            resetOrders();
                            refreshOrderFrame({ shopId: null, force: true });
                            return;
                        }

                        var targetRawId = res.shop.id;
                        var targetId = normalizeShopId(targetRawId);
                        var targetName = res.shop.name || '';
                        var displayName = targetName || targetRawId;

                        if (currentShop && currentShop.id === targetId) {
                            setStatus('目前顯示店家：' + displayName, 'success');
                            updateShopCard(targetName, targetRawId, { keepVisible: true });
                            refreshOrderFrame({ shopId: targetRawId });
                            return;
                        }

                        var joinShop = function () {
                            hub.server.joinShop(targetRawId)
                                .done(function (success) {
                                    if (!success) {
                                        currentShop = null;
                                        setStatus('沒有此店家', 'error');
                                        updateShopCard('沒有此店家', null, { state: 'error', keepVisible: true, placeholderId: shopId });
                                        refreshOrderFrame({ shopId: null, force: true });
                                        resetOrders();
                                        return;
                                    }

                                    currentShop = { id: targetId, rawId: targetRawId, name: targetName };
                                    setStatus('目前顯示店家：' + displayName, 'success');
                                    updateShopCard(targetName, targetRawId, { keepVisible: true });
                                    resetOrders();
                                    refreshOrderFrame({ shopId: targetRawId, force: true });
                                })
                                .fail(function () {
                                    currentShop = null;
                                    setStatus('加入店家通道失敗。', 'error');
                                    updateShopCard('加入店家通道失敗', null, { state: 'error', keepVisible: true, placeholderId: shopId });
                                    refreshOrderFrame({ shopId: null, force: true });
                                });
                        };

                        if (currentShop && currentShop.rawId) {
                            var leaving = currentShop;
                            currentShop = null;
                            hub.server.leaveShop(leaving.rawId).always(function () {
                                appendStatus('已離開店家 ' + (leaving.name || leaving.rawId) + ' 的訂閱。');
                                joinShop();
                            });
                        } else {
                            joinShop();
                        }
                    })
                    .fail(function (xhr) {
                        var message = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : '查詢店家時發生錯誤。';
                        currentShop = null;
                        setStatus(message, 'error');
                        updateShopCard(message, null, { state: 'error', keepVisible: true, placeholderId: shopId });
                        refreshOrderFrame({ shopId: null, force: true });
                    });
            }

            function getInitialShopId() {
                var params = new URLSearchParams(window.location.search);
                return params.get('id') || params.get('shopId') || params.get('shop');
            }

            resetOrders();

            if (!hasInitialShop) {
                var queryInitial = getInitialShopId();
                if (queryInitial) {
                    initialShopId = queryInitial;
                    hasInitialShop = true;
                    if ($shopInput && $shopInput.length) {
                        $shopInput.val(initialShopId);
                    }
                }
            }

            if (hasInitialShop && $shopInput && $shopInput.length) {
                $shopInput.val(initialShopId);
            }

            if (!hasInitialShop) {
                hideInterface();
                setStatus('');
            }

            refreshOrderFrame({ shopId: hasInitialShop ? initialShopId : null, force: true });

            hub.client.orderChanged = function (payload) {
                appendOrderNotification(payload);
            };

            $.connection.hub.start()
                .done(function () {
                    isHubReady = true;
                    if (hasInitialShop) {
                        subscribeToShop(initialShopId);
                    }
                })
                .fail(function () {
                    setStatus('SignalR 連線失敗，請重新整理頁面。', 'error');
                });
        })();
    </script>
</body>
</html>
